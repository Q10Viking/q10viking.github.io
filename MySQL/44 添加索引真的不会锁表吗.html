<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/images/favicon-32x32.png"><title>静默のBlog</title><meta name="description" content="静默的Vuepress Blog">
    <link rel="preload" href="/assets/js/runtime~app.2c87fbe0.js" as="script"><link rel="preload" href="/assets/css/styles.b779b927.css" as="style"><link rel="preload" href="/assets/js/95615.aba5921d.js" as="script"><link rel="preload" href="/assets/js/app.4aafd1f6.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b779b927.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">静默のBlog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item"></p><ul class=""><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#mysql-ddl执行方式" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="MySQL DDL执行方式"><!--[--><!--]--> MySQL DDL执行方式 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#数据准备" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="数据准备"><!--[--><!--]--> 数据准备 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#使用algorithm-inplace-lock-none" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用ALGORITHM = INPLACE，Lock = NONE;"><!--[--><!--]--> 使用ALGORITHM = INPLACE，Lock = NONE; <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#使用algorithm-copy-lock-exclusive" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用ALGORITHM = COPY，Lock = EXCLUSIVE;"><!--[--><!--]--> 使用ALGORITHM = COPY，Lock = EXCLUSIVE; <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#模拟online-ddl执行时-有其他事务持有mdl锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="模拟online ddl执行时，有其他事务持有MDL锁"><!--[--><!--]--> 模拟online ddl执行时，有其他事务持有MDL锁 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#参数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="参数"><!--[--><!--]--> 参数 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#algorithm" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ALGORITHM："><!--[--><!--]--> ALGORITHM： <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/44%20%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95%E7%9C%9F%E7%9A%84%E4%B8%8D%E4%BC%9A%E9%94%81%E8%A1%A8%E5%90%97.html#lock" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="LOCK："><!--[--><!--]--> LOCK： <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="mysql-ddl执行方式" tabindex="-1"><a class="header-anchor" href="#mysql-ddl执行方式" aria-hidden="true">#</a> MySQL DDL执行方式</h2><p>MySQL5.5以及之前的版本，通常更改数据表结构操作(DDL)会阻塞对表数据的增删改操作(DML)。 MySQL5.6提供Online DDL之后可支持DDL与DML操作同时执行，降低了DDL期间对业务延迟带来的影响</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>数据操作语言DML（Data Manipulation Language）
数据库模式定义语言DDL(Data Definition Language)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="数据准备" tabindex="-1"><a class="header-anchor" href="#数据准备" aria-hidden="true">#</a> 数据准备</h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>scores<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> scores <span class="token punctuation">(</span>
   id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;序号&#39;</span><span class="token punctuation">,</span>
   student_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;学号&#39;</span><span class="token punctuation">,</span>
   course_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;课程名称&#39;</span><span class="token punctuation">,</span>
   score <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;分数&#39;</span><span class="token punctuation">,</span>
	 remarks <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;备注&#39;</span><span class="token punctuation">,</span>
	 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> scores<span class="token punctuation">;</span> <span class="token comment">--240w</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="使用algorithm-inplace-lock-none" tabindex="-1"><a class="header-anchor" href="#使用algorithm-inplace-lock-none" aria-hidden="true">#</a> 使用ALGORITHM = INPLACE，Lock = NONE;</h3><p>使用INPLACE，NONE时不阻塞其他事务的DML操作。</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> scores <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_student_id<span class="token punctuation">;</span>
事务A使用online ddl添加索引:
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> scores <span class="token keyword">ADD</span> <span class="token keyword">index</span> idx_student_id <span class="token punctuation">(</span>student_id<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token keyword">ALGORITHM</span><span class="token operator">=</span>INPLACE<span class="token punctuation">,</span> <span class="token keyword">LOCK</span><span class="token operator">=</span>NONE<span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

<span class="token number">1.</span>事务A使用online ddl添加索引，事务B进行查询，可以正常读取：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> scores <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>


<span class="token number">2.</span>事务A使用online ddl添加索引，事务B进行修改，可以正常修改：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> scores <span class="token keyword">set</span> course_name <span class="token operator">=</span> <span class="token string">&#39;张三&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

<span class="token number">3.</span>事务A使用online ddl添加索引，事务B进行删除，可以正常删除：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> scores <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span>

<span class="token number">4.</span>事务A使用online ddl添加索引，事务B进行插入，可以正常插入：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>scores<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>student_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>course_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>score<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>remarks<span class="token punctuation">`</span></span><span class="token punctuation">)</span> 
	<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mock_Chinese1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;71&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="使用algorithm-copy-lock-exclusive" tabindex="-1"><a class="header-anchor" href="#使用algorithm-copy-lock-exclusive" aria-hidden="true">#</a> 使用ALGORITHM = COPY，Lock = EXCLUSIVE;</h3><p>使用COPY，EXCLUSIVE时，会阻塞其他事务的DML操作。当DDL事务提交后，其他事务才能正常DML操作</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> scores <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_student_id<span class="token punctuation">;</span>
事务A使用online ddl添加索引:
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> scores <span class="token keyword">ADD</span> <span class="token keyword">index</span> idx_student_id <span class="token punctuation">(</span>student_id<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token keyword">ALGORITHM</span><span class="token operator">=</span>COPY<span class="token punctuation">,</span> <span class="token keyword">LOCK</span><span class="token operator">=</span>EXCLUSIVE<span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

<span class="token number">1.</span>事务A使用online ddl添加索引，事务B进行查询出现阻塞，需等事务A结束：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> scores <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

<span class="token number">2.</span>事务A使用online ddl添加索引，事务B进行修改出现阻塞，需等事务A结束：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> scores <span class="token keyword">set</span> course_name <span class="token operator">=</span> <span class="token string">&#39;张三&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

<span class="token number">3.</span>事务A使用online ddl添加索引，事务B进行删除出现阻塞，需等事务A结束：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> scores <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span>

<span class="token number">4.</span>事务A使用online ddl添加索引，事务B进行插入出现阻塞，需等事务A结束：
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>scores<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>student_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>course_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>score<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>remarks<span class="token punctuation">`</span></span><span class="token punctuation">)</span> 
	<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mock_Chinese1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;71&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks_mock_remarks&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="模拟online-ddl执行时-有其他事务持有mdl锁" tabindex="-1"><a class="header-anchor" href="#模拟online-ddl执行时-有其他事务持有mdl锁" aria-hidden="true">#</a> 模拟online ddl执行时，有其他事务持有MDL锁</h3><p>Online DDL 过程必须等待已经持有MDL锁的并发事务提交或者回滚才能继续执行</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> scores <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_student_id<span class="token punctuation">;</span>
事务A进行查询，不提交事务:
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> scores<span class="token punctuation">;</span>
<span class="token comment">--commit;</span>

事务B使用online ddl添加索引，阻塞中:
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> scores <span class="token keyword">ADD</span> <span class="token keyword">index</span> idx_student_id <span class="token punctuation">(</span>student_id<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token keyword">ALGORITHM</span><span class="token operator">=</span>INPLACE<span class="token punctuation">,</span> <span class="token keyword">LOCK</span><span class="token operator">=</span>NONE<span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

事务C进行查询，阻塞中:
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> scores <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>

查询进程信息：
<span class="token keyword">show</span> processlist<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="参数" tabindex="-1"><a class="header-anchor" href="#参数" aria-hidden="true">#</a> 参数</h2><h3 id="algorithm" tabindex="-1"><a class="header-anchor" href="#algorithm" aria-hidden="true">#</a> <strong>ALGORITHM：</strong></h3><p>**ALGORITHM=DEFAULT：**默认算法，使用最高效的算法 **ALGORITHM=INPLACE：**在原表上进行更改，不需要生成临时表，不需要进行数据copy的过程。 添加索引步骤： 1.创建索引(二级索引)数据字典 2.加共享表锁，禁止DML，允许查询 3.读取聚簇索引，构造新的索引项，排序并插入新索引 4.等待打开当前表的所有只读事务提交 5.创建索引结束</p><p>**ALGORITHM=COPY：**最原始的方式，通过临时表创建索引，需要多一倍存储，还有更多的IO（类似5.6版本之前的处理过程） 添加索引步骤： 1.新建带索引（主键索引）的临时表 2.锁原表，禁止DML，允许查询 3.将原表数据拷贝到临时表 4.禁止读写,进行rename，升级字典锁 5.完成创建索引操作</p><h3 id="lock" tabindex="-1"><a class="header-anchor" href="#lock" aria-hidden="true">#</a> <strong>LOCK：</strong></h3><p>**LOCK=DEFAULT：**默认方式，MySQL自行判断使用哪种LOCK模式，尽量不锁表 **LOCK=NONE：**无锁：允许Online DDL期间进行并发读写操作。如果Online DDL操作不支持对表的继续写入，则DDL操作失败，对表修改无效 **LOCK=SHARED：**共享锁：Online DDL操作期间堵塞写入，不影响读取 **LOCK=EXCLUSIVE：**排它锁：Online DDL操作期间不允许对锁表进行任何操作</p><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/MySQL/" class="nav-link router-link-active" aria-label="Back To 目录"><!--[--><!--]--> Back To 目录 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.2c87fbe0.js" defer></script><script src="/assets/js/95615.aba5921d.js" defer></script><script src="/assets/js/app.4aafd1f6.js" defer></script>
  </body>
</html>
