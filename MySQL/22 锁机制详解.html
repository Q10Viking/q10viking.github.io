<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/images/favicon-32x32.png"><title>静默のBlog</title><meta name="description" content="静默的Vuepress Blog">
    <link rel="preload" href="/assets/js/runtime~app.2c87fbe0.js" as="script"><link rel="preload" href="/assets/css/styles.b779b927.css" as="style"><link rel="preload" href="/assets/js/95615.aba5921d.js" as="script"><link rel="preload" href="/assets/js/app.4aafd1f6.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b779b927.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">静默のBlog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item"></p><ul class=""><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#锁详解" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="锁详解"><!--[--><!--]--> 锁详解 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#锁分类" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="锁分类"><!--[--><!--]--> 锁分类 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#全局锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="全局锁"><!--[--><!--]--> 全局锁 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#表锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="表锁"><!--[--><!--]--> 表锁 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#案例分析-加读锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="案例分析(加读锁）"><!--[--><!--]--> 案例分析(加读锁） <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#案例分析-加写锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="案例分析(加写锁）"><!--[--><!--]--> 案例分析(加写锁） <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#表元数据锁" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="表元数据锁"><!--[--><!--]--> 表元数据锁 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#行锁⭐" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="行锁⭐"><!--[--><!--]--> 行锁⭐ <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#行锁演示" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="行锁演示"><!--[--><!--]--> 行锁演示 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#行锁与事务隔离级别案例分析⭐" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="行锁与事务隔离级别案例分析⭐"><!--[--><!--]--> 行锁与事务隔离级别案例分析⭐ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#死锁和死锁检测" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="死锁和死锁检测"><!--[--><!--]--> 死锁和死锁检测 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#行锁升级为表锁❤️" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="行锁升级为表锁❤️"><!--[--><!--]--> 行锁升级为表锁❤️ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#间隙锁-gap-lock" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="间隙锁(Gap Lock)"><!--[--><!--]--> 间隙锁(Gap Lock) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#临键锁-next-key-locks" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="临键锁(Next-key Locks)"><!--[--><!--]--> 临键锁(Next-key Locks) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#测试数据" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="测试数据"><!--[--><!--]--> 测试数据 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#锁分析" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="锁分析"><!--[--><!--]--> 锁分析 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#查看information-schema系统库锁相关数据表" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="查看INFORMATION_SCHEMA系统库锁相关数据表"><!--[--><!--]--> 查看INFORMATION_SCHEMA系统库锁相关数据表 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/MySQL/22%20%E9%94%81%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3.html#锁优化" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="锁优化"><!--[--><!--]--> 锁优化 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="锁详解" tabindex="-1"><a class="header-anchor" href="#锁详解" aria-hidden="true">#</a> <strong>锁详解</strong></h2><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。</p><p>在数据库中，除了传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供需要用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。</p><h2 id="锁分类" tabindex="-1"><a class="header-anchor" href="#锁分类" aria-hidden="true">#</a> <strong>锁分类</strong></h2><ul><li>从性能上分为<strong>乐观锁</strong>(用版本对比来实现)和<strong>悲观锁</strong><ul><li>乐观锁没有锁等待</li><li>悲观锁会有锁等待的阻塞</li></ul></li><li>从对数据库操作的类型分，分为<strong>读锁</strong>和<strong>写锁</strong>(都属于悲观锁),还有<strong>意向锁</strong><ul><li>读锁（共享锁，S锁(<strong>S</strong>hared)）：针对同一份数据，多个读操作可以同时进行而不会互相影响</li><li>写锁（排它锁，X锁(e<strong>X</strong>clusive)）：当前写操作没有完成前，它会阻断其他写锁和读锁</li><li><strong>意向锁</strong>（Intention Lock）：又称I锁，针对表锁，主要是为了提高加表锁的效率，是mysql数据库自己加的。当有事务给表的数据行加了共享锁或排他锁，同时会给表设置一个标识，代表已经有行锁了，其他事务要想对表加表锁时，就不必逐行判断有没有行锁可能跟表锁冲突了，直接读这个标识就可以确定自己该不该加表锁。特别是表中的记录很多时，逐行判断加表锁的方式效率很低。而这个标识就是意向锁 <ul><li>意向共享锁，IS锁，对整个表加共享锁之前，需要先获取到意向共享锁。</li><li>意向排他锁，IX锁，对整个表加排他锁之前，需要先获取到意向排他锁</li></ul></li></ul></li><li>从对数据操作的粒度分，分为<strong>全局锁</strong>、<strong>表锁</strong>和<strong>行锁</strong></li></ul><h2 id="全局锁" tabindex="-1"><a class="header-anchor" href="#全局锁" aria-hidden="true">#</a> 全局锁</h2><blockquote><p>全局锁主要用在逻辑备份过程中。对于全部是 InnoDB 引擎的库，我建议你选择使用–single-transaction 参数，对应用会更友好。</p></blockquote><p>全局锁就是对整个数据库实例加锁。MySQL 提供了一个加全局读锁的方法，命令是 Flush tables with read lock (FTWRL)。当你需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句</p><p>**全局锁的典型使用场景是，做全库逻辑备份。**也就是把整库每个表都 select 出来存成文本。</p><p>以前有一种做法，是通过 FTWRL 确保不会有其他线程对数据库做更新，然后对整个库做备份。注意，在备份过程中整个库完全处于只读状态。</p><p>但是让整库都只读，听上去就很危险：</p><ul><li>如果你在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆；</li><li>如果你在从库上备份，那么备份期间从库不能执行主库同步过来的 binlog，会导致主从延迟。</li></ul><hr><p>看来加全局锁不太好。但是细想一下，备份为什么要加锁呢？我们来看一下不加锁会有什么问题。</p><p>假设你现在要维护一个购买系统，关注的是用户账户余额表和用户课程表。</p><p>现在发起一个逻辑备份。假设备份期间，有一个用户，他购买了一门课程，业务逻辑里就要扣掉他的余额，然后往已购课程里面加上一门课</p><blockquote><p>如果时间顺序上是先备份账户余额表 (u_account)，然后用户购买，然后备份用户课程表 (u_course)，会怎么样呢？</p></blockquote><p><img src="/images/MySQL/image-20230509175034320.png" alt="image-20230509175034320"></p><p>可以看到，这个备份结果里，用户 A 的数据状态是“账户余额没扣，但是用户课程表里面已经多了一门课”。如果后面用这个备份来恢复数据的话，就会导致数据不一致的情况。</p><p>官方自带的逻辑备份工具是 mysqldump。当 mysqldump 使用参数–single-transaction 的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。</p><p>有了这个功能，为什么还需要 FTWRL 呢？**一致性读是好，但前提是引擎要支持这个隔离级别。**比如，对于 MyISAM 这种不支持事务的引擎，如果备份过程中有更新，总是只能取到最新的数据，那么就破坏了备份的一致性。这时，我们就需要使用 FTWRL 命令了。</p><p>所以，**single-transaction 方法只适用于所有的表使用事务引擎的库。**如果有的表使用了不支持事务的引擎，那么备份就只能通过 FTWRL 方法。这往往是 DBA 要求业务开发人员使用 InnoDB 替代 MyISAM 的原因之一。</p><h2 id="表锁" tabindex="-1"><a class="header-anchor" href="#表锁" aria-hidden="true">#</a> <strong>表锁</strong></h2><blockquote><p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)</p></blockquote><p>每次操作锁住整张表。开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低；一般用在整表数据迁移的场景。</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--建表SQL</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>mylock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
	<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
	<span class="token identifier"><span class="token punctuation">`</span>NAME<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> MyISAM <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

<span class="token comment">--插入数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span><span class="token identifier"><span class="token punctuation">`</span>mylock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>NAME<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span><span class="token identifier"><span class="token punctuation">`</span>mylock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>NAME<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;2&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span><span class="token identifier"><span class="token punctuation">`</span>mylock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>NAME<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;3&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span><span class="token identifier"><span class="token punctuation">`</span>mylock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>NAME<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;4&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><p>手动增加表锁:</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">lock</span> <span class="token keyword">table</span> 表名称 <span class="token keyword">read</span><span class="token punctuation">(</span><span class="token keyword">write</span><span class="token punctuation">)</span><span class="token punctuation">,</span>表名称<span class="token number">2</span> <span class="token keyword">read</span><span class="token punctuation">(</span><span class="token keyword">write</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>查看表上加过的锁</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">open</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>删除表锁</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li></ul><h3 id="案例分析-加读锁" tabindex="-1"><a class="header-anchor" href="#案例分析-加读锁" aria-hidden="true">#</a> <strong>案例分析(加读锁）</strong></h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mysql&gt; lock table mylock read;
Query OK, 0 rows affected (0.00 sec)
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当前session和其他session都可以读该表</p><p>当前session中插入或者更新锁定的表都会报错，其他session插入或更新则会等待</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 当前session插入失败</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>mylock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>NAME<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR <span class="token number">1099</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Table</span> <span class="token string">&#39;mylock&#39;</span> was locked <span class="token keyword">with</span> a <span class="token keyword">READ</span> <span class="token keyword">lock</span> <span class="token operator">and</span> can<span class="token string">&#39;t be updated

-- 其他session则会等待，直到加锁的session释放锁
mysql&gt; INSERT INTO `mylock` (`id`, `NAME`) VALUES (&#39;</span><span class="token number">1</span><span class="token string">&#39;, &#39;</span>a&#39;<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="案例分析-加写锁" tabindex="-1"><a class="header-anchor" href="#案例分析-加写锁" aria-hidden="true">#</a> <strong>案例分析(加写锁）</strong></h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code> <span class="token keyword">lock</span> <span class="token keyword">table</span> mylock <span class="token keyword">write</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>当前session对该表的增删改查都没有问题，其他session对该表的所有操作被阻塞(直到锁被释放)</p><h3 id="表元数据锁" tabindex="-1"><a class="header-anchor" href="#表元数据锁" aria-hidden="true">#</a> 表元数据锁</h3><p>MDL 不需要显式使用，<strong>在访问一个表的时候会被自动加上</strong>。MDL 的作用是，保证读写的正确性</p><p>如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的</p><blockquote><p>在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁</p><p>MDL 锁是系统默认会加的</p></blockquote><p>给一个表加字段，或者修改字段，或者加索引，需要扫描全表的数据。在对大表操作的时候，会特别小心，以免对线上服务造成影响</p><p><img src="/images/MySQL/image-20230509183240661.png" alt="image-20230509183240661"></p><ul><li>session A 先启动，这时候会对表 t 加一个 MDL 读锁。由于 session B 需要的也是 MDL 读锁，因此可以正常执行。</li><li>之后 session C 会被 blocked，是因为 session A 的 MDL 读锁还没有释放，而 session C 需要 MDL 写锁，因此只能被阻塞。</li><li>如果只有 session C 自己被阻塞还没什么关系，但是之后所有要在表 t 上新申请 MDL 读锁的请求也会被 session C 阻塞。</li><li>所有对表的增删改查操作都需要先申请 MDL 读锁，就都被锁住，等于这个表现在完全不可读写了</li></ul><p>如果某个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满</p><h2 id="行锁⭐" tabindex="-1"><a class="header-anchor" href="#行锁⭐" aria-hidden="true">#</a> 行锁⭐</h2><blockquote><p>MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。不支持行锁意味着并发控制只能使用表锁，对于这种引擎的表，同一张表上任何时刻只能有一个更新在执行，这就会影响到业务并发度。InnoDB 是支持行锁的，这也是 MyISAM 被 InnoDB 替代的重要原因之一</p></blockquote><p>行锁就是针对数据表中行记录的锁。比如事务 A 更新了一行，而这时候事务 B 也要更新同一行，则必须等事务 A 的操作完成后才能进行更新</p><p>每次操作锁住一行数据。开销大，加锁慢；<strong>会出现死锁</strong>；锁定粒度最小，发生锁冲突的概率最低，并发度最高。</p><p>InnoDB与MYISAM的最大不同有两点：</p><ul><li><strong>InnoDB支持事务（TRANSACTION）</strong></li><li><strong>InnoDB支持行级锁</strong></li></ul><h3 id="行锁演示" tabindex="-1"><a class="header-anchor" href="#行锁演示" aria-hidden="true">#</a> <strong>行锁演示</strong></h3><p>一个session开启事务更新不提交，<strong>另一个session更新同一条记录会阻塞，更新不同记录不会阻塞</strong></p><p><img src="/images/MySQL/image-20211030094505516.png" alt="image-20211030094505516"></p><p>**总结：**⭐</p><ol><li><strong>MyISAM在执行查询语句SELECT前，会自动给涉及的所有表加读锁,在执行update、insert、delete操作会自动给涉及的表加写锁。</strong></li><li><strong>InnoDB在执行查询语句SELECT时(非串行隔离级别)，不会加锁</strong>。但是<strong>update、insert、delete操作会加行锁</strong>。</li></ol><p>简而言之，就是<strong>读锁会阻塞写，但是不会阻塞读。而写锁则会把读和写都阻塞</strong>。</p><hr><h3 id="行锁与事务隔离级别案例分析⭐" tabindex="-1"><a class="header-anchor" href="#行锁与事务隔离级别案例分析⭐" aria-hidden="true">#</a> <strong>行锁与事务隔离级别案例分析⭐</strong></h3><p>事务 B 的 update 语句会被阻塞，直到事务 A 执行 commit 之后，事务 B 才能继续执行</p><p><img src="/images/MySQL/image-20230509184147557.png" alt="image-20230509184147557"></p><blockquote><p><strong>在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议</strong></p></blockquote><p>如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放</p><p>比如实现一个电影票在线交易业务，顾客 A 要在影院 B 购买电影票</p><ol><li>从顾客 A 账户余额中扣除电影票价；</li><li>给影院 B 的账户余额增加这张电影票价；</li><li>记录一条交易日志。</li></ol><p>为了保证交易的原子性，我们要把这三个操作放在一个事务中。</p><p>如果同时有另外一个顾客 C 要在影院 B 买票，那么这两个事务冲突的部分就是语句 2 了。因为它们要更新同一个影院账户的余额，需要修改同一行数据</p><p>把语句 2 安排在最后，比如按照 3、1、2 这样的顺序，那么影院账户余额这一行的锁时间就最少。这就最大程度地减少了事务之间的锁等待，提升了并发度</p><h3 id="死锁和死锁检测" tabindex="-1"><a class="header-anchor" href="#死锁和死锁检测" aria-hidden="true">#</a> 死锁和死锁检测</h3><p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态，称为死锁</p><p><img src="/images/MySQL/image-20230509185532898.png" alt="image-20230509185532898"></p><p>事务 A 在等待事务 B 释放 id=2 的行锁，而事务 B 在等待事务 A 释放 id=1 的行锁。 事务 A 和事务 B 在互相等待对方的资源释放，就是进入了死锁状态。当出现死锁以后，有两种策略：</p><ul><li><p>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置。</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%innodb_lock_wait_timeout%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------+-------+</span>
<span class="token operator">|</span> Variable_name            <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+-------+</span>
<span class="token operator">|</span> innodb_lock_wait_timeout <span class="token operator">|</span> <span class="token number">50</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------+-------+</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在 InnoDB 中，innodb_lock_wait_timeout 的默认值是 50s，意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过 50s 才会超时退出，然后其他线程才有可能继续执行。</p></li><li><p>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%innodb_deadlock_detect%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> Variable_name          <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
<span class="token operator">|</span> innodb_deadlock_detect <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------+-------+</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>正常情况下我们还是要采用第二种策略，即：主动死锁检测，而且 innodb_deadlock_detect 的默认值本身就是 on。</p><p><img src="/images/MySQL/image-20230509190844023.png" alt="image-20230509190844023"></p><p>主动死锁检测在发生死锁的时候，是能够快速发现并进行处理的，但是它也是有额外负担的</p><p>比如所有事务都是更新同一行数据，每个新来的被堵住的线程，都要判断会不会由于自己的加入导致了死锁，这是一个时间复杂度是 O(n) 的操作。假设有 1000 个并发线程要同时更新同一行，那么死锁检测操作就是 100 万这个量级的。虽然最终检测的结果是没有死锁，但是这期间要消耗大量的 CPU 资源。因此，你就会看到 CPU 利用率很高，但是每秒却执行不了几个事务。</p></li></ul><blockquote><p>怎么解决由这种热点行更新导致的性能问题呢？问题的症结在于，死锁检测要耗费大量的 CPU 资源</p></blockquote><p>可以从设计上优化这个问题。</p><p>以影院账户为例，可以考虑放在多条记录上，比如 10 个记录，影院的账户总额等于这 10 个记录的值的总和。这样每次要给影院账户加金额的时候，随机选其中一条记录来加。这样每次冲突概率变成原来的 1/10，可以减少锁等待个数，也就减少了死锁检测的 CPU 消耗。</p><p>这个方案看上去是无损的，但其实这类方案需要根据业务逻辑做详细设计。如果账户余额可能会减少，比如退票逻辑，那么这时候就需要考虑当一部分行记录变成 0 的时候，代码要有特殊处理。</p><hr><h3 id="行锁升级为表锁❤️" tabindex="-1"><a class="header-anchor" href="#行锁升级为表锁❤️" aria-hidden="true">#</a> 行锁升级为表锁❤️</h3><p><strong>无索引行锁会升级为表锁(RR（Repeatable read可重复读）级别会升级为表锁，RC（Read committed读已提交）级别不会升级为表锁)</strong></p><p>锁主要是加在索引上，如果对非索引字段更新，行锁可能会变表锁</p><ul><li><p>session1 执行：update account set balance = 800 where name = &#39;lilei&#39;;</p></li><li><p>session2 对该表任一行操作都会阻塞住</p></li></ul><p><strong>InnoDB的行锁是针对索引加的锁，不是针对记录加的锁。并且该索引不能失效，否则都会从行锁升级为表锁</strong>**</p><p>锁定某一行还可以用lock in share mode(共享锁) 和for update(排它锁)，例如：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_innodb_lock <span class="token keyword">where</span> a <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这样其他session只能读这行数据，修改则会被阻塞，直到锁定行的session提交</p><h2 id="间隙锁-gap-lock" tabindex="-1"><a class="header-anchor" href="#间隙锁-gap-lock" aria-hidden="true">#</a> 间隙锁(Gap Lock)</h2><p>间隙锁，锁的就是两个值之间的空隙。Mysql默认级别是repeatable-read，有办法解决幻读问题吗？间隙锁在某些情况下可以解决幻读问题。</p><p>假设account表里数据如下：</p><p>​ <img src="/images/MySQL/98874.png" alt="0"></p><p>那么间隙就有 id 为 (3,10)，(10,20)，(20,正无穷) 这三个区间，</p><p>在Session_1下面执行 update account set name = &#39;zhuge&#39; where id &gt; 8 and id &lt;18;，则其他Session没法在这个<strong>范围所包含的所有行记录(包括间隙行记录)以及行记录所在的间隙</strong>里插入或修改任何数据，即id在(3,20]区间都无法修改数据，注意最后那个20也是包含在内的。</p><blockquote><p><strong>间隙锁是在可重复读隔离级别下才会生效</strong></p></blockquote><h2 id="临键锁-next-key-locks" tabindex="-1"><a class="header-anchor" href="#临键锁-next-key-locks" aria-hidden="true">#</a> <strong>临键锁(Next-key Locks)</strong></h2><p>临键锁是行锁与间隙锁的组合。像上面那个例子里的这个(3,20]的整个区间可以叫做临键锁。</p><h2 id="测试数据" tabindex="-1"><a class="header-anchor" href="#测试数据" aria-hidden="true">#</a> 测试数据</h2><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;lilei&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;450&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;hanmei&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;16000&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>account<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>balance<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;lucy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2400&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="锁分析" tabindex="-1"><a class="header-anchor" href="#锁分析" aria-hidden="true">#</a> 锁分析</h2><blockquote><p><strong>通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况</strong></p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">&#39;innodb_row_lock%&#39;</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token operator">|</span> Variable_name                 <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
<span class="token operator">|</span> Innodb_row_lock_current_waits <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time          <span class="token operator">|</span> <span class="token number">12654</span> <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time_avg      <span class="token operator">|</span> <span class="token number">6327</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_time_max      <span class="token operator">|</span> <span class="token number">12654</span> <span class="token operator">|</span>
<span class="token operator">|</span> Innodb_row_lock_waits         <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------------+-------+</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对各个状态量的说明如下：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>Innodb_row_lock_current_waits: 当前正在等待锁定的数量
Innodb_row_lock_time: 从系统启动到现在锁定总时间长度
Innodb_row_lock_time_avg: 每次等待所花平均时间
Innodb_row_lock_time_max：从系统启动到现在等待最长的一次所花时间
Innodb_row_lock_waits: 系统启动后到现在总共等待的次数
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对于这5个状态变量，比较重要的主要是：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Innodb_row_lock_time_avg （等待平均时长）
Innodb_row_lock_waits （等待总次数）
Innodb_row_lock_time（等待总时长）
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化计划。</p></blockquote><h3 id="查看information-schema系统库锁相关数据表" tabindex="-1"><a class="header-anchor" href="#查看information-schema系统库锁相关数据表" aria-hidden="true">#</a> <strong>查看INFORMATION_SCHEMA系统库锁相关数据表</strong></h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 查看事务 其中会有事务对应的线程id</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_TRX<span class="token punctuation">;</span>
<span class="token comment">-- 查看锁  -- </span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_LOCKS<span class="token punctuation">;</span>  
<span class="token comment">-- mysql8 换成了</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>performance_schema<span class="token punctuation">`</span></span><span class="token punctuation">.</span>data_locks<span class="token punctuation">;</span>



<span class="token comment">-- 查看锁等待</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> INFORMATION_SCHEMA<span class="token punctuation">.</span>INNODB_LOCK_WAITS<span class="token punctuation">;</span>
<span class="token comment">-- mysql8 换成了</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>data_lock_waits<span class="token punctuation">;</span>

<span class="token comment">-- 释放锁，trx_mysql_thread_id可以从INNODB_TRX表里查看到</span>
<span class="token keyword">kill</span> trx_mysql_thread_id

<span class="token comment">-- 查看锁等待详细信息</span>
<span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span>\G<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><img src="/images/MySQL/image-20220520020557241.png" alt="image-20220520020557241"></p><h2 id="锁优化" tabindex="-1"><a class="header-anchor" href="#锁优化" aria-hidden="true">#</a> 锁优化</h2><ul><li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</li><li>合理设计索引，尽量缩小锁的范围</li><li>尽可能减少检索条件范围，避免间隙锁</li><li>尽量控制事务大小，减少锁定资源量和时间长度，<strong>涉及事务加锁的sql尽量放在事务最后执行</strong></li><li>尽可能低级别事务隔离</li></ul><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/MySQL/" class="nav-link router-link-active" aria-label="Back To 目录"><!--[--><!--]--> Back To 目录 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.2c87fbe0.js" defer></script><script src="/assets/js/95615.aba5921d.js" defer></script><script src="/assets/js/app.4aafd1f6.js" defer></script>
  </body>
</html>
