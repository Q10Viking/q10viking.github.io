---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To 目录
  link: /SpringCloud/
typora-root-url: ..\.vuepress\public
---



## Oauth2整合网关实现微服务单点登录

网关整合 OAuth2.0 有两种思路，一种是授权服务器生成令牌, 所有请求统一在网关层验证，判断权限等操作；另一种是由各资源服务处理，网关只做请求转发。  比较常用的是第一种，把API网关作为OAuth2.0的资源服务器角色，实现接入客户端权限拦截、令牌解析并转发当前登录用户信息给微服务，这样下游微服务就不需要关心令牌格式解析以及OAuth2.0相关机制了。

网关在认证授权体系里主要负责两件事： 
1. 作为OAuth2.0的资源服务器角色，实现接入方权限拦截。
2. 令牌解析并转发当前登录用户信息（明文token）给微服务

微服务拿到明文token(明文token中包含登录用户的身份和权限信息)后也需要做两件事： 

1. 用户授权拦截（看当前用户是否有权访问该资源）
2. 将用户信息存储进当前线程上下文（有利于后续业务逻辑随时获取当前用户信息）

![img](/images/springsecurity/56868)



## 授权服务器

[http://localhost:8888/oauth/token?username=hzz&password=Root.123456&grant_type=password&client_id=gateway-server&client_secret=123123&scope=all](http://localhost:8888/oauth/token?username=hzz&password=Root.123456&grant_type=password&client_id=gateway-server&client_secret=123123&scope=all)





## 检验token

可以拿到用户名称，权限的信息等。

![image-20230314202501691](/images/springsecurity/image-20230314202501691.png)

![image-20230314212053193](/images/springsecurity/image-20230314212053193.png)

```json
{
	"active": true,
	"exp": 1678803564,
	"user_name": "hzz",
	"authorities": [
		"/contents/",
		"/contents/view/**",
		"/users/",
		"/contents/update/**",
		"/contents/delete/**",
		"/contents/insert/**",
		"/"
	],
	"client_id": "gateway-server",
	"scope": [
		"all"
	]
}
```



