---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To 目录
  link: /ElasticStack/
typora-root-url: ..\.vuepress\public
---



## 聚合搜索

### bucket

::: tip

bucket就是一个聚合搜索时的数据分组

:::

如：销售部门有员工张三和李四，开发部门有员工王五和赵六。那么根据部门分组聚合得到结果就是两个bucket。销售部门bucket中有张三和李四，开发部门 bucket中有王五和赵六。



### metric

::: tip

metric就是对一个bucket数据执行的统计分析

metric有多种统计，如：求和(sum)，最大值(max)，最小值(min)，平均值(avg)等。

:::

如上述案例中，开发部门有2个员工，销售部门有2个员工，这就是metric。





## 数据准备

::: tip

在接下来的文章中，将使用案例来说明聚合搜索，比较形象。提前准备一些数据

:::

::: details 文档映射

```json
PUT /cars
{
  "mappings": {
    "properties": {
      "price": {
        "type": "long"
      },
      "color": {
        "type": "keyword"
      },
      "brand": {
        "type": "keyword"
      },
      "model": {
        "type": "keyword"
      },
      "sold_date": {
        "type": "date"
      },
      "remark": {
        "type": "text",
        "analyzer": "ik_max_word"
      }
    }
  }
}
```

:::

----------

::: details 具体数据

```json
POST /cars/_bulk
{ "index": {}}
{ "price" : 258000, "color" : "金色", "brand":"大众", "model" : "大众迈腾", "sold_date" : "2021-10-28","remark" : "大众中档车" }
{ "index": {}}
{ "price" : 123000, "color" : "金色", "brand":"大众", "model" : "大众速腾", "sold_date" : "2021-11-05","remark" : "大众神车" }
{ "index": {}}
{ "price" : 239800, "color" : "白色", "brand":"标志", "model" : "标志508", "sold_date" : "2021-05-18","remark" : "标志品牌全球上市车型" }
{ "index": {}}
{ "price" : 148800, "color" : "白色", "brand":"标志", "model" : "标志408", "sold_date" : "2021-07-02","remark" : "比较大的紧凑型车" }
{ "index": {}}
{ "price" : 1998000, "color" : "黑色", "brand":"大众", "model" : "大众辉腾", "sold_date" : "2021-08-19","remark" : "大众最让人肝疼的车" }
{ "index": {}}
{ "price" : 218000, "color" : "红色", "brand":"奥迪", "model" : "奥迪A4", "sold_date" : "2021-11-05","remark" : "小资车型" }
{ "index": {}}
{ "price" : 489000, "color" : "黑色", "brand":"奥迪", "model" : "奥迪A6", "sold_date" : "2022-01-01","remark" : "政府专用？" }
{ "index": {}}
{ "price" : 1899000, "color" : "黑色", "brand":"奥迪", "model" : "奥迪A 8", "sold_date" : "2022-02-12","remark" : "很贵的大A6。。。" }
```

:::



## 根据分组统计数量

::: tip

只执行聚合分组，不做复杂的聚合统计。**在ES中最基础的聚合为terms**，相当于SQL中的count。

在ES中默认为分组数据做排序，使用的是doc_count数据执行降序排列。可以使用 \_key元数据，根据分组后的字段数据执行不同的排序方案，也可以根据 **_count元数据**，根据分组后的统计值执行不同的排序方案。 

:::

```json
#根据color分组统计销售数量
GET /cars/_search
{
  "aggs": {
    "group_by_color": {
      "terms": {
        "field": "color",
        "order": {
          "_count": "desc"
        }
      }
    }
  }
}
```

![image-20220813025948653](/images/elasticsearch/image-20220813025948653.png)



## 根据分组计算平均值

先根据color执行聚合分组，在此分组的基础上，对组内数据执行聚合统计，这个组内数据的聚合统计就是metric。

同样可以执行排序，因为组内有聚合统计

且对统计数据给予了命名avg_by_price，所以可以根据这个聚合统计数据字段名执行排序逻辑。

```json
#统计不同color车辆的平均价格
GET /cars/_search
{
  "aggs": {
    "group_by_color": {
      "terms": {
        "field": "color",
        "order": {
          "avg_by_price": "asc"
        }
      },
      "aggs": {
        "avg_by_price": {
          "avg": {
            "field": "price"
          }
        }
      }
    }
  }
}
```

![image-20220813030341507](/images/elasticsearch/image-20220813030341507.png)

----------



## 下钻分析❤️

::: tip

统计不同color下，不同brand中车辆的平均价格。先根据color聚合分组，在组内根据brand再次聚合分组，这种操作可以称为**下钻分析**。

嵌套定义称为下钻分析。水平定义就是平铺多个分组方式

:::



```json
#统计不同color下，不同brand中车辆的平均价格
GET /cars/_search
{
  "aggs": {
    "group_by_color": {
      "terms": {
        "field": "color",
        "order": {
          "avg_by_price_color": "asc"
        }
      },
      "aggs": {
        "avg_by_price_color": {
          "avg": {
            "field": "price"
          }
        },
        "group_by_brand": {
          "terms": {
            "field": "brand",
            "order": {
              "avg_by_price_brand": "desc"
            }
          },
          "aggs": {
            "avg_by_price_brand": {
              "avg": {
                "field": "price"
              }
            }
          }
        }
      }
    }
  }
}
```

![image-20220813031848962](/images/elasticsearch/image-20220813031848962.png)



## 根据分组求最大值&最小值&求和❤️

::: tip

在常见的业务常见中，聚合分析，最常用的种类就是统计数量，最大，最小，平均，总计等。通常占有聚合业务中的60%以上的比例，小型项目中，甚至占比85%以上

:::

```json
#统计不同color中的最大和最小价格、总价
GET /cars/_search
{
  "size": 0, 
  "aggs": {
    "group_by_color": {
      "terms": {
        "field": "color"
      },
      "aggs": {
        "max_price": {
          "max": {
            "field": "price"
          }
        },
        "min_price": {
          "min": {
            "field": "price"
          }
        },
        "sum_price": {
          "sum": {
            "field": "price"
          }
        }
      }
    }
  }
}
```

![image-20220813032325152](/images/elasticsearch/image-20220813032325152.png)

----------



## 根据分组查询排序最靠前的数据❤️

1. 在分组后，可能需要对组内的数据进行排序，并选择其中排名高的数据。那么可以使用size来实现：top_hits中的属性size代表取组内多少条数据（默认为10）；
2. sort代表组内使用什么字段什么规则排序（默认使用 \_doc的asc规则排序）；
3. \_source代表结果中包含document中的那些字段（默认包含全部字段）。

```json
#统计不同品牌汽车中价格排名最高的车型
GET cars/_search
{
  "size": 0,
  "aggs": {
    "group_by_brand": {
      "terms": {
        "field": "brand"
      },
      "aggs": {
        "top_car": {
          "top_hits": {
            "size": 1,
            "sort": [
              {
                "price": {
                  "order": "desc"
                }
              }
            ],
            "_source": {
              "includes": [
                "model",
                "price"
              ]
            }
          }
        }
      }
    }
  }
}
```

![image-20220813033206878](/images/elasticsearch/image-20220813033206878.png)



## 聚合统计中不返回具体文档

::: tip

size可以设置为0，表示不返回ES中的文档，只返回ES聚合之后的数据，提高查询速度，当然如果你需要这些文档的话，也可以按照实际情况进行设置

:::

![image-20220813030805026](/images/elasticsearch/image-20220813030805026.png)