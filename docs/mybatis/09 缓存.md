---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To 目录
  link: /mybatis/
typora-root-url: ..\.vuepress\public
---



::: tip

[Source Code 05 mybatis cache](https://github.com/Q10Viking/learncode/tree/main/mybatis/05_mybatis_cache)

:::

## 一级缓存

线程级别的缓存，是本地缓存，sqlSession级别的缓存。在开发过程中，一般不管他。但是还是需要了解一下。

### 特性❤️

```java
/**
 * 一级缓存
 * 特性：
 * 1.默认就开启了，也可以关闭一级缓存 localCacheScope=STATEMENT
 * 2.作用域：是基于sqlSession（默认），一次数据库操作会话。
 * 3.缓存默认实现类PerpetualCache ,使用map进行存储的(可以进去打断点观察)
 * 4.查询完就会进行存储
 * 5.先从二级缓存中获取，再从一级缓存中获取
 * key==>   hashcode+sqlid+sql
 * 失效情况：
 * 1.不同的sqlSession会使一级缓存失效
 * 2.同一个SqlSession，但是查询语句不一样
 * 3.同一个SqlSession，查询语句一样，但是期间执行增删改操作
 * 4.同一个SqlSession，查询语句一样，执行手动清除缓存  sqlSession.clearCache();
 */
```



### 默认开启的体现

```java
@Test
public void test01(){
    try(SqlSession sqlSession = sqlSessionFactory.openSession()){
        DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
        // 虽然代码中查询了两次，但是实际上只从数据库查询了一次
        List<Dept> depts = mapper.selectDept(null);
        List<Dept> depts2 = mapper.selectDept(null);
    }
}
```

![image-20220807205520016](/images/mybatis/image-20220807205520016.png)

### 失效的验证

#### 不同的sqlsession

```java
/**
     * 一级缓存的作用域是在sqlSession
     * 不同的sqlSession会导致缓存失效
     */
    @Test
    public void test02(){
        try(SqlSession sqlSession = sqlSessionFactory.openSession()){
            DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
            // 虽然代码中查询了两次，但是实际上只从数据库查询了一次
            List<Dept> depts = mapper.selectDept(null);
        }

        try(SqlSession sqlSession = sqlSessionFactory.openSession()){
            DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
            List<Dept> depts2 = mapper.selectDept(null);
        }
    }
```

![image-20220807210152870](/images/mybatis/image-20220807210152870.png)

#### 查询语句不一样

```java
@Test
public void test03(){
    try(SqlSession sqlSession = sqlSessionFactory.openSession()){
        DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
        Dept dept1 = new Dept();
        dept1.setDeptId(1);
        mapper.selectDept(dept1);

        Dept dept2 = new Dept();
        //dept2.setDeptId(1);  // 会走一级缓存
        dept2.setDeptName("经理"); // 缓存失效
        mapper.selectDept(dept2);
    }
}
```

![image-20220807210854579](/images/mybatis/image-20220807210854579.png)

#### 查询语句一样，但是期间执行增删改操作

```java
@Test
public void test04(){
    try(SqlSession sqlSession = sqlSessionFactory.openSession()){
        DeptMapper mapper = sqlSession.getMapper(DeptMapper.class);
        Dept dept1 = new Dept();
        dept1.setDeptId(1);
        mapper.selectDept(dept1);

        // 执行了增删改的操作
        EmpMapper empMapper = sqlSession.getMapper(EmpMapper.class);
        Emp emp = new Emp();
        emp.setUsername("cache");
        empMapper.insertEmp(emp);

        Dept dept2 = new Dept();
        dept2.setDeptId(1);
        mapper.selectDept(dept2);
        sqlSession.commit();
    }
}
```

![image-20220807211857232](/images/mybatis/image-20220807211857232.png)