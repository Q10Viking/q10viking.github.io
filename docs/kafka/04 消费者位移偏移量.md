---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To 目录
  link: /kafka/
typora-root-url: ..\.vuepress\public
---



## 消费者位移主题

> 新版本 Consumer 的位移管理机制就是将 Consumer 的位移数据作为一条条普通的 Kafka 消息，提交到 __consumer_offsets 中。可以这么说，__consumer_offsets 的主要作用是保存 Kafka 消费者的位移信息。它要求这个提交过程不仅要实现高持久性，还要支持高频的写操作。

![image-20230422135104093](/images/kafka/image-20230422135104093.png)

```sh
q10viking@LAPTOP-PJLAUUSP:~/software/kafka_2.12-2.5.0/kafka-logs$ ls
__consumer_offsets-0   __consumer_offsets-34
__consumer_offsets-1   __consumer_offsets-35
__consumer_offsets-10  __consumer_offsets-36
__consumer_offsets-11  __consumer_offsets-37
__consumer_offsets-12  __consumer_offsets-38
__consumer_offsets-13  __consumer_offsets-39
__consumer_offsets-14  __consumer_offsets-4
__consumer_offsets-15  __consumer_offsets-40
__consumer_offsets-16  __consumer_offsets-41
__consumer_offsets-17  __consumer_offsets-42
__consumer_offsets-18  __consumer_offsets-43
__consumer_offsets-19  __consumer_offsets-44
__consumer_offsets-2   __consumer_offsets-45
__consumer_offsets-20  __consumer_offsets-46
__consumer_offsets-21  __consumer_offsets-47
__consumer_offsets-22  __consumer_offsets-48
__consumer_offsets-23  __consumer_offsets-49
__consumer_offsets-24  __consumer_offsets-5
__consumer_offsets-25  __consumer_offsets-6
__consumer_offsets-26  __consumer_offsets-7
__consumer_offsets-27  __consumer_offsets-8
__consumer_offsets-28  __consumer_offsets-9
__consumer_offsets-29  cleaner-offset-checkpoint
__consumer_offsets-3   log-start-offset-checkpoint
__consumer_offsets-30  meta.properties
__consumer_offsets-31  recovery-point-offset-checkpoint
__consumer_offsets-32  replication-offset-checkpoint
__consumer_offsets-33  test-0
```

### 消息

`__consumer_offsets` 的每条消息格式大致如图所示

![img](/images/kafka/7000.png)





## 分析



> 创建一个主题test,分区6

```sh
 bin/kafka-topics.sh --create --zookeeper 172.29.96.105:2181 --replication-factor 1 --partitions 6 --topic test
```



> 创建一个消费者属于order-group消费组，消费test主题

```sh
bin/kafka-console-consumer.sh --bootstrap-server 172.29.96.105:9092 --topic test 
# 指定消费者分组
bin/kafka-console-consumer.sh --bootstrap-server  172.29.96.105:9092 --group order-group --topic test
```

会创建一个消费者进行消费

```
[Consumer clientId=consumer-order-group-1, groupId=order-group] 
```



> 生产消费

```sh
bin/kafka-console-producer.sh --broker-list 172.29.96.105:9092 --topic test
```

### 测试

> 测试一个消费组order-group中有两个消费者，生产6条消息
> 可以看到消息只会被消费一次，左边的消费到了3条，右边的消费到了3条

![image-20230422151458500](/images/kafka/image-20230422151458500.png)





### 查看消费位移



```sh
bin/kafka-consumer-groups.sh --bootstrap-server 172.29.96.105:9092 --describe --group order-group
```

可以看到主题下的6个分区都被消费组的2个消费者给接管了

![image-20230422152153042](/images/kafka/image-20230422152153042.png)

```sh
GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                                 HOST            CLIENT-ID
order-group     test            0          2               2               0               consumer-order-group-1-0ff47fdc-30d1-421d-9541-91681c21c881 /172.29.96.105  consumer-order-group-1
order-group     test            1          0               0               0               consumer-order-group-1-0ff47fdc-30d1-421d-9541-91681c21c881 /172.29.96.105  consumer-order-group-1
order-group     test            2          1               1               0               consumer-order-group-1-0ff47fdc-30d1-421d-9541-91681c21c881 /172.29.96.105  consumer-order-group-1
order-group     test            3          0               0               0               consumer-order-group-1-b32793ec-1bdd-4c47-857a-e49966548bc0 /172.29.96.105  consumer-order-group-1
order-group     test            4          1               1               0               consumer-order-group-1-b32793ec-1bdd-4c47-857a-e49966548bc0 /172.29.96.105  consumer-order-group-1
order-group     test            5          2               2               0               consumer-order-group-1-b32793ec-1bdd-4c47-857a-e49966548bc0 /172.29.96.105  consumer-order-group-1
q10viking@LAPTOP-PJLAUUSP:~/software/kafka_2.12-2.5.0$
```



> 现在再启动一个消费者,6个分区做了调整分配给3个消费者，并且新的消费者继承了之前的消费位点

![image-20230422153005839](/images/kafka/image-20230422153005839.png)







## 参考

[【kafka原理】 消费者偏移量__consumer_offsets_相关解析 - 腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1846774)

[kafka 查看消费者组_kafka查看消费者组命令_鸭梨山大哎的博客-CSDN博客](https://blog.csdn.net/u010711495/article/details/112133491)

