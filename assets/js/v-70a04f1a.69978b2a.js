"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[88710],{72469:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-70a04f1a",path:"/netty/25%20netty%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8B%E6%9C%BA%E5%88%B6.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/netty/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"心跳机制介绍",slug:"心跳机制介绍",children:[]},{level:2,title:"实现",slug:"实现",children:[]},{level:2,title:"IdleStateHandler底层原理",slug:"idlestatehandler底层原理",children:[{level:3,title:"定时任务分析",slug:"定时任务分析",children:[]}]}],filePathRelative:"netty/25 netty心跳检测机制.md"}},79891:(n,s,a)=>{a.r(s),a.d(s,{default:()=>g});var e=a(20641);const t=(0,e.Fv)('<h2 id="心跳机制介绍" tabindex="-1"><a class="header-anchor" href="#心跳机制介绍" aria-hidden="true">#</a> 心跳机制介绍</h2><p>所谓心跳, 即在 TCP 长连接中, 客户端和服务器之间定期发送的一种特殊的数据包, 通知对方自己还在线, 以确保 TCP 连接的有效性.</p><p>是在应用层面上的服务端与客户端的交互。主要在服务端实现</p><p>在 Netty 中, 实现心跳机制的关键是 IdleStateHandler, 看下它的构造器</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> readerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token keyword">int</span> writerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token keyword">int</span> allIdleTimeSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>readerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>writerIdleTimeSeconds<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>allIdleTimeSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里解释下三个参数的含义：</p><ul><li>readerIdleTimeSeconds: 读超时. 即当在指定的时间间隔内没有从 Channel 读取到数据时, 会触发一个 READER_IDLE 的 IdleStateEvent 事件.</li><li>writerIdleTimeSeconds: 写超时. 即当在指定的时间间隔内没有数据写入到 Channel 时, 会触发一个 WRITER_IDLE 的 IdleStateEvent 事件.</li><li>allIdleTimeSeconds: 读/写超时. 即当在指定的时间间隔内没有读或写操作时, 会触发一个 ALL_IDLE 的 IdleStateEvent 事件.</li></ul><p>注：这三个参数默认的时间单位是秒。若需要指定其他时间单位，可以使用另一个构造方法</p><h2 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h2>',9),p={href:"https://github.com/Q10Viking/learncode/tree/main/Netty/HelloWorld/src/main/java/org/hzz/idlestate",target:"_blank",rel:"noopener noreferrer"},o={href:"https://www.processon.com/view/link/643aacca52b63f1f044e8022",target:"_blank",rel:"noopener noreferrer"},k=(0,e.Lk)("p",null,[(0,e.Lk)("img",{src:"/images/netty/心跳机制.png",alt:"心跳机制"})],-1),c=(0,e.Lk)("blockquote",null,[(0,e.Lk)("p",null,"服务端")],-1),l=(0,e.Lk)("div",{class:"language-java ext-java line-numbers-mode"},[(0,e.Lk)("pre",{class:"language-java"},[(0,e.Lk)("code",null,[(0,e.Lk)("span",{class:"token annotation punctuation"},"@Slf4j"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"HeartBeatServerHandler"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"extends"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"SimpleChannelInboundHandler"),(0,e.Lk)("span",{class:"token generics"},[(0,e.Lk)("span",{class:"token punctuation"},"<"),(0,e.Lk)("span",{class:"token class-name"},"String"),(0,e.Lk)("span",{class:"token punctuation"},">")]),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token keyword"},"protected"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"channelRead0"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"ChannelHandlerContext"),(0,e.eW)(" ctx"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"String"),(0,e.eW)(" msg"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"throws"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Exception"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token class-name"},"System"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.eW)("out"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"println"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"收到客户端消息："'),(0,e.eW)(),(0,e.Lk)("span",{class:"token operator"},"+"),(0,e.eW)(" msg"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"HeartBeat Packet"'),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"equals"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("msg"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            ctx"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"writeAndFlush"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"Server OK"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.Lk)("span",{class:"token keyword"},"else"),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"收到客户端消息："'),(0,e.eW)(),(0,e.Lk)("span",{class:"token operator"},"+"),(0,e.eW)(" msg"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n\n    "),(0,e.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"userEventTriggered"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"ChannelHandlerContext"),(0,e.eW)(" ctx"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Object"),(0,e.eW)(" evt"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"throws"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Exception"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n\n        "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("evt "),(0,e.Lk)("span",{class:"token keyword"},"instanceof"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"IdleStateEvent"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token class-name"},"IdleStateEvent"),(0,e.eW)(" event "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"IdleStateEvent"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(" evt"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token keyword"},"switch"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("event"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"state"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token keyword"},"case"),(0,e.eW)(),(0,e.Lk)("span",{class:"token constant"},"READER_IDLE"),(0,e.Lk)("span",{class:"token operator"},":"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"读空闲, 关闭连接"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token function"},"closeChannel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("ctx"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token keyword"},"case"),(0,e.eW)(),(0,e.Lk)("span",{class:"token constant"},"WRITER_IDLE"),(0,e.Lk)("span",{class:"token operator"},":"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"写空闲"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token keyword"},"break"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token keyword"},"case"),(0,e.eW)(),(0,e.Lk)("span",{class:"token constant"},"ALL_IDLE"),(0,e.Lk)("span",{class:"token operator"},":"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"读写空闲"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token keyword"},"break"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n\n    "),(0,e.Lk)("span",{class:"token keyword"},"private"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"closeChannel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"ChannelHandlerContext"),(0,e.eW)(" ctx"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token class-name"},"SocketAddress"),(0,e.eW)(" loc "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(" ctx"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"localAddress"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token class-name"},"SocketAddress"),(0,e.eW)(" rem "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(" ctx"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"remoteAddress"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        ctx"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"writeAndFlush"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"idle close"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        ctx"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"close"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addListener"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future "),(0,e.Lk)("span",{class:"token operator"},"->"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"isSuccess"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"关闭连接成功: loc={}, rem={}"'),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(" loc"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(" rem"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"else"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"关闭连接失败: loc={}, rem={}"'),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(" loc"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(" rem"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n")])]),(0,e.Lk)("div",{class:"line-numbers"},[(0,e.Lk)("span",{class:"line-number"},"1"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"2"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"3"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"4"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"5"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"6"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"7"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"8"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"9"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"10"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"11"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"12"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"13"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"14"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"15"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"16"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"17"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"18"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"19"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"20"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"21"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"22"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"23"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"24"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"25"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"26"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"27"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"28"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"29"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"30"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"31"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"32"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"33"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"34"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"35"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"36"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"37"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"38"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"39"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"40"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"41"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"42"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"43"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"44"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"45"),(0,e.Lk)("br")])],-1),u=(0,e.Lk)("div",{class:"language-java ext-java line-numbers-mode"},[(0,e.Lk)("pre",{class:"language-java"},[(0,e.Lk)("code",null,[(0,e.Lk)("span",{class:"token annotation punctuation"},"@Slf4j"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"HeartBeatServer"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"static"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"main"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"String"),(0,e.Lk)("span",{class:"token punctuation"},"["),(0,e.Lk)("span",{class:"token punctuation"},"]"),(0,e.eW)(" args"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token class-name"},"EventLoopGroup"),(0,e.eW)(" bossGroup "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"NioEventLoopGroup"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token class-name"},"EventLoopGroup"),(0,e.eW)(" workerGroup "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"NioEventLoopGroup"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n\n        "),(0,e.Lk)("span",{class:"token keyword"},"try"),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token class-name"},"ServerBootstrap"),(0,e.eW)(" serverBootstrap "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ServerBootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            serverBootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"group"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("bossGroup"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(" workerGroup"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"NioServerSocketChannel"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"childHandler"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ServerChannelInitializer"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n\n            "),(0,e.Lk)("span",{class:"token class-name"},"ChannelFuture"),(0,e.eW)(" bindFuture "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(" serverBootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"bind"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"InetSocketAddress"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token number"},"8080"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            bindFuture"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addListener"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future "),(0,e.Lk)("span",{class:"token operator"},"->"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"isSuccess"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"端口绑定成功,port:{}"'),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"InetSocketAddress"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("bindFuture"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"localAddress"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"getPort"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"else"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"端口绑定失败"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            bindFuture"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"closeFuture"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"sync"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"catch"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"InterruptedException"),(0,e.eW)(" e"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token keyword"},"throw"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"RuntimeException"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("e"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"finally"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            bossGroup"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"shutdownGracefully"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            workerGroup"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"shutdownGracefully"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n\n    "),(0,e.Lk)("span",{class:"token keyword"},"private"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"static"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ServerChannelInitializer"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"extends"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ChannelInitializer"),(0,e.Lk)("span",{class:"token generics"},[(0,e.Lk)("span",{class:"token punctuation"},"<"),(0,e.Lk)("span",{class:"token class-name"},"SocketChannel"),(0,e.Lk)("span",{class:"token punctuation"},">")]),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token keyword"},"protected"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"initChannel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"SocketChannel"),(0,e.eW)(" ch"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"throws"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Exception"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            ch"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"pipeline"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"StringEncoder"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"StringDecoder"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"IdleStateHandler"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token number"},"3"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token number"},"0"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token number"},"0"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"TimeUnit"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token constant"},"SECONDS"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"HeartBeatServerHandler"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n")])]),(0,e.Lk)("div",{class:"line-numbers"},[(0,e.Lk)("span",{class:"line-number"},"1"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"2"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"3"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"4"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"5"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"6"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"7"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"8"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"9"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"10"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"11"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"12"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"13"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"14"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"15"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"16"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"17"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"18"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"19"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"20"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"21"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"22"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"23"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"24"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"25"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"26"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"27"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"28"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"29"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"30"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"31"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"32"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"33"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"34"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"35"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"36"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"37"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"38"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"39"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"40"),(0,e.Lk)("br")])],-1),i=(0,e.Lk)("blockquote",null,[(0,e.Lk)("p",null,"客户端")],-1),L=(0,e.Lk)("div",{class:"language-java ext-java line-numbers-mode"},[(0,e.Lk)("pre",{class:"language-java"},[(0,e.Lk)("code",null,[(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"HeartBeatClientHandler"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"extends"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"SimpleChannelInboundHandler"),(0,e.Lk)("span",{class:"token generics"},[(0,e.Lk)("span",{class:"token punctuation"},"<"),(0,e.Lk)("span",{class:"token class-name"},"String"),(0,e.Lk)("span",{class:"token punctuation"},">")]),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token keyword"},"protected"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"channelRead0"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"ChannelHandlerContext"),(0,e.eW)(" ctx"),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"String"),(0,e.eW)(" msg"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"throws"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Exception"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("msg "),(0,e.Lk)("span",{class:"token operator"},"!="),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"null"),(0,e.eW)(),(0,e.Lk)("span",{class:"token operator"},"&&"),(0,e.eW)(" msg"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"equals"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"idle close"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            ctx"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"close"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addListener"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future "),(0,e.Lk)("span",{class:"token operator"},"->"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"isSuccess"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"服务器主动关闭连接,客户端也关闭连接"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"else"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"关闭连接失败"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n")])]),(0,e.Lk)("div",{class:"line-numbers"},[(0,e.Lk)("span",{class:"line-number"},"1"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"2"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"3"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"4"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"5"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"6"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"7"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"8"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"9"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"10"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"11"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"12"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"13"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"14"),(0,e.Lk)("br")])],-1),r=(0,e.Lk)("div",{class:"language-java ext-java line-numbers-mode"},[(0,e.Lk)("pre",{class:"language-java"},[(0,e.Lk)("code",null,[(0,e.Lk)("span",{class:"token annotation punctuation"},"@Slf4j"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"HeartBeatClient"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token keyword"},"public"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"static"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"main"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"String"),(0,e.Lk)("span",{class:"token punctuation"},"["),(0,e.Lk)("span",{class:"token punctuation"},"]"),(0,e.eW)(" args"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token class-name"},"Bootstrap"),(0,e.eW)(" bootstrap "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Bootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token keyword"},"try"),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            bootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"group"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"NioEventLoopGroup"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"NioSocketChannel"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"remoteAddress"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"localhost"'),(0,e.Lk)("span",{class:"token punctuation"},","),(0,e.eW)(),(0,e.Lk)("span",{class:"token number"},"8080"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"handler"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ClientChannelInitializer"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token class-name"},"ChannelFuture"),(0,e.eW)(" connect "),(0,e.Lk)("span",{class:"token operator"},"="),(0,e.eW)(" bootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"connect"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            connect"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addListener"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future "),(0,e.Lk)("span",{class:"token operator"},"->"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token keyword"},"if"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("future"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"isSuccess"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"连接成功"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"else"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n                    log"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"info"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token string"},'"连接失败"'),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n                "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n            connect"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"channel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"closeFuture"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"sync"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"catch"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"InterruptedException"),(0,e.eW)(" e"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            "),(0,e.Lk)("span",{class:"token keyword"},"throw"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"RuntimeException"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.eW)("e"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"finally"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            bootstrap"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"group"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"shutdownGracefully"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n\n    "),(0,e.Lk)("span",{class:"token keyword"},"private"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"static"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"class"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ClientChannelInitializer"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"extends"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"ChannelInitializer"),(0,e.Lk)("span",{class:"token generics"},[(0,e.Lk)("span",{class:"token punctuation"},"<"),(0,e.Lk)("span",{class:"token class-name"},"SocketChannel"),(0,e.Lk)("span",{class:"token punctuation"},">")]),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token keyword"},"protected"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"void"),(0,e.eW)(),(0,e.Lk)("span",{class:"token function"},"initChannel"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token class-name"},"SocketChannel"),(0,e.eW)(" ch"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)(),(0,e.Lk)("span",{class:"token keyword"},"throws"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"Exception"),(0,e.eW)(),(0,e.Lk)("span",{class:"token punctuation"},"{"),(0,e.eW)("\n            ch"),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"pipeline"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"StringEncoder"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"StringDecoder"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.eW)("\n                    "),(0,e.Lk)("span",{class:"token punctuation"},"."),(0,e.Lk)("span",{class:"token function"},"addLast"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token keyword"},"new"),(0,e.eW)(),(0,e.Lk)("span",{class:"token class-name"},"HeartBeatClientHandler"),(0,e.Lk)("span",{class:"token punctuation"},"("),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},")"),(0,e.Lk)("span",{class:"token punctuation"},";"),(0,e.eW)("\n        "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n    "),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n"),(0,e.Lk)("span",{class:"token punctuation"},"}"),(0,e.eW)("\n\n")])]),(0,e.Lk)("div",{class:"line-numbers"},[(0,e.Lk)("span",{class:"line-number"},"1"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"2"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"3"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"4"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"5"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"6"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"7"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"8"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"9"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"10"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"11"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"12"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"13"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"14"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"15"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"16"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"17"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"18"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"19"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"20"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"21"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"22"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"23"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"24"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"25"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"26"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"27"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"28"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"29"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"30"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"31"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"32"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"33"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"34"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"35"),(0,e.Lk)("br"),(0,e.Lk)("span",{class:"line-number"},"36"),(0,e.Lk)("br")])],-1),b=(0,e.Fv)('<blockquote><p>测试</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 服务端</span>\n<span class="token number">21</span>:32:36.774 <span class="token punctuation">[</span>nioEventLoopGroup-2-1<span class="token punctuation">]</span> o.h.i.HeartBeatServer - lambda<span class="token variable">$main</span><span class="token variable">$0</span> - INFO  端口绑定成功,port:8080\n<span class="token number">21</span>:32:51.082 <span class="token punctuation">[</span>nioEventLoopGroup-3-1<span class="token punctuation">]</span> o.h.i.HeartBeatServerHandler - userEventTriggered - INFO  读空闲, 关闭连接\n<span class="token number">21</span>:32:51.104 <span class="token punctuation">[</span>nioEventLoopGroup-3-1<span class="token punctuation">]</span> o.h.i.HeartBeatServerHandler - lambda<span class="token variable">$closeChannel</span><span class="token variable">$0</span> - INFO  关闭连接成功: <span class="token assign-left variable">loc</span><span class="token operator">=</span>/127.0.0.1:8080, <span class="token assign-left variable">rem</span><span class="token operator">=</span>/127.0.0.1:12480\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#客户端</span>\n<span class="token number">21</span>:32:48.080 <span class="token punctuation">[</span>nioEventLoopGroup-2-1<span class="token punctuation">]</span> o.h.i.HeartBeatClient - lambda<span class="token variable">$main</span><span class="token variable">$0</span> - INFO  连接成功\n<span class="token number">21</span>:32:51.119 <span class="token punctuation">[</span>nioEventLoopGroup-2-1<span class="token punctuation">]</span> o.h.i.HeartBeatClientHandler - lambda<span class="token variable">$channelRead0</span><span class="token variable">$0</span> - INFO  服务器主动关闭连接,客户端也关闭连接\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="idlestatehandler底层原理" tabindex="-1"><a class="header-anchor" href="#idlestatehandler底层原理" aria-hidden="true">#</a> IdleStateHandler底层原理</h2><ul><li>它是入站和出站的handler</li></ul><p><img src="/images/netty/image-20230415222513592.png" alt="image-20230415222513592"></p>',6),d={href:"https://www.processon.com/view/link/643ad31dcbedfb624bef258f",target:"_blank",rel:"noopener noreferrer"},m=(0,e.Lk)("h3",{id:"定时任务分析",tabindex:"-1"},[(0,e.Lk)("a",{class:"header-anchor",href:"#定时任务分析","aria-hidden":"true"},"#"),(0,e.eW)(" 定时任务分析")],-1),W=(0,e.Lk)("blockquote",null,[(0,e.Lk)("p",null,"定时任务的执行核心逻辑: 从优先级队列（底层是最小堆）中取出第一个任务"),(0,e.Lk)("p",null,"然后比较现在时间是否已经大于了延迟时间，比如现在是12点，延迟时间是11点，那么就取出该任务执行。")],-1),w={href:"https://q10viking.github.io/Algorithm/%E5%8D%81%E5%A4%A7%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95.html#%E5%A0%86%E6%8E%92%E5%BA%8F%E2%9D%A4%EF%B8%8F",target:"_blank",rel:"noopener noreferrer"},f=(0,e.Fv)('<blockquote><p>核心模板</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">runAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">assert</span> <span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">boolean</span> fetchedAll<span class="token punctuation">;</span>\n    <span class="token keyword">boolean</span> ranAtLeastOne <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 这里的循环是确保取所有到期的任务执行。因为取出来要放到另外一个队列</span>\n    <span class="token comment">// 因为另外一个队列可能有任务积压，取出来放不进去，所以又退回到了优先级队列。</span>\n    <span class="token comment">// 等待另外一个普通队列任务执行完，再去优先级任务中获取</span>\n    <span class="token keyword">do</span> <span class="token punctuation">{</span>\t\t\t\t\t\t\t\t\t\t\t\t\n        fetchedAll <span class="token operator">=</span> <span class="token function">fetchFromScheduledTaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runAllTasksFrom</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 执行队列任务</span>\n            ranAtLeastOne <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>fetchedAll<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// keep on processing until we fetched all scheduled tasks.</span>\n    <span class="token keyword">return</span> ranAtLeastOne<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fetchFromScheduledTaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledTaskQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> scheduledTaskQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    <span class="token keyword">long</span> nanoTime <span class="token operator">=</span> <span class="token class-name">AbstractScheduledEventExecutor</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Runnable</span> scheduledTask <span class="token operator">=</span> <span class="token function">pollScheduledTask</span><span class="token punctuation">(</span>nanoTime<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>scheduledTask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 添加不进去，可能现在任务队列满了，需要先把队列挤压的任务执行</span>\n            <span class="token comment">// No space left in the task queue add it back to the scheduledTaskQueue so we pick it up again.</span>\n            scheduledTaskQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> scheduledTask<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> <span class="token function">pollScheduledTask</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanoTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">assert</span> <span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScheduledFutureTask</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> scheduledTaskQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledTaskQueue<span class="token punctuation">;</span>\n        <span class="token comment">// 核心逻辑</span>\n        <span class="token class-name">ScheduledFutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> scheduledTask <span class="token operator">=</span> scheduledTaskQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> scheduledTaskQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 取出任务看看是否到了可执行的时机</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>scheduledTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> scheduledTask<span class="token punctuation">.</span><span class="token function">deadlineNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> nanoTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        scheduledTaskQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> scheduledTask<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div>',4),h={},g=(0,a(66262).A)(h,[["render",function(n,s){const a=(0,e.g2)("OutboundLink"),h=(0,e.g2)("CodeGroupItem"),g=(0,e.g2)("CodeGroup"),y=(0,e.g2)("common-progresson-snippet");return(0,e.uX)(),(0,e.CE)(e.FK,null,[t,(0,e.Lk)("p",null,[(0,e.Lk)("a",p,[(0,e.eW)("Source Code"),(0,e.bF)(a)])]),(0,e.Lk)("p",null,[(0,e.Lk)("a",o,[(0,e.eW)("心跳机制| ProcessOn免费在线作图,在线流程图,在线思维导图"),(0,e.bF)(a)])]),k,c,(0,e.bF)(g,null,{default:(0,e.k6)((()=>[(0,e.bF)(h,{title:"HeartBeatServerHandler"},{default:(0,e.k6)((()=>[l])),_:1}),(0,e.bF)(h,{title:"HeartBeatServer"},{default:(0,e.k6)((()=>[u])),_:1})])),_:1}),i,(0,e.bF)(g,null,{default:(0,e.k6)((()=>[(0,e.bF)(h,{title:"HeartBeatClientHandler"},{default:(0,e.k6)((()=>[L])),_:1}),(0,e.bF)(h,{title:"HeartBeatClient"},{default:(0,e.k6)((()=>[r])),_:1})])),_:1}),b,(0,e.Lk)("p",null,[(0,e.Lk)("a",d,[(0,e.eW)("idlesate以及定时执行任务分析| ProcessOn免费在线作图,在线流程图,在线思维导图"),(0,e.bF)(a)])]),(0,e.bF)(y,{src:"https://www.processon.com/view/link/643ad31dcbedfb624bef258f"}),m,W,(0,e.Lk)("p",null,[(0,e.Lk)("a",w,[(0,e.eW)("静默のBlog 堆排序"),(0,e.bF)(a)])]),f],64)}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}}}]);