"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[4558],{83407:(s,n,a)=>{a.r(n),a.d(n,{data:()=>e});const e={key:"v-5bdf5914",path:"/RocketMQ/03%20RocketMQ%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/RocketMQ/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"机器环境",slug:"机器环境",children:[{level:3,title:"三台虚拟机规划",slug:"三台虚拟机规划",children:[]},{level:3,title:"关闭防火墙",slug:"关闭防火墙",children:[]}]},{level:2,title:"配置RocketMQ集群(2主2从异步刷盘)",slug:"配置rocketmq集群-2主2从异步刷盘",children:[{level:3,title:"配置第一组broker-a",slug:"配置第一组broker-a",children:[]},{level:3,title:"配置第二组Broker-b",slug:"配置第二组broker-b",children:[]},{level:3,title:"小结",slug:"小结",children:[]}]},{level:2,title:"启动RocketMQ⭐",slug:"启动rocketmq⭐",children:[{level:3,title:"先启动nameServer",slug:"先启动nameserver",children:[]},{level:3,title:"再启动broker",slug:"再启动broker",children:[]}]},{level:2,title:"关闭机器",slug:"关闭机器",children:[]},{level:2,title:"查看效果",slug:"查看效果",children:[]}],filePathRelative:"RocketMQ/03 RocketMQ集群搭建.md"}},84508:(s,n,a)=>{a.r(n),a.d(n,{default:()=>p});const e=(0,a(20641).Fv)('<div class="custom-container tip"><p class="custom-container-title">TIP</p><p>主从架构，主是干什么的（收发消息），从是干什么的（做备份）</p></div><h2 id="机器环境" tabindex="-1"><a class="header-anchor" href="#机器环境" aria-hidden="true">#</a> 机器环境</h2><h3 id="三台虚拟机规划" tabindex="-1"><a class="header-anchor" href="#三台虚拟机规划" aria-hidden="true">#</a> 三台虚拟机规划</h3><p>准备三台虚拟机，root密码 123456;IP地址：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">192.168</span>.187.135 （work1）<span class="token comment"># 以它为主</span>\n<span class="token number">192.168</span>.187.130 （work2）\n<span class="token number">192.168</span>.187.132\t（work3）\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr><h3 id="关闭防火墙" tabindex="-1"><a class="header-anchor" href="#关闭防火墙" aria-hidden="true">#</a> 关闭防火墙</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>systemctl stop firewalld.service\nfirewall-cmd <span class="token parameter variable">--state</span> \n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="配置rocketmq集群-2主2从异步刷盘" tabindex="-1"><a class="header-anchor" href="#配置rocketmq集群-2主2从异步刷盘" aria-hidden="true">#</a> 配置RocketMQ集群(2主2从异步刷盘)</h2><p>我们为了便于观察，这次搭建一个<strong>2主2从异步刷盘</strong>的集群，所以我们会使用conf/2m-2s-async下的配置文件，实际项目中，为了达到高可用，一般会使用dleger。预备设计的集群情况如下：</p><table><thead><tr><th>机器</th><th>nemaeServer节点部署</th><th>broker节点部署</th></tr></thead><tbody><tr><td>192.168.187.135 (work1)</td><td>nameserver</td><td></td></tr><tr><td>192.168.187.130 (work2)</td><td>nameserver</td><td>broker-a, broker-b-s</td></tr><tr><td>192.168.187.132 (work3)</td><td>nameserver</td><td>broker-b,broker-a-s</td></tr></tbody></table><p>所以修改的配置文件是进入rocketmq的config目录下修改2m-2s-async的配置文件。--只需要配置broker.conf。</p><blockquote><p>在rocketmq的config目录下可以看到rocketmq建议的各种配置方式：</p><ul><li>2m-2s-async: 2主2从异步刷盘(吞吐量较大，但是消息可能丢失),</li><li>2m-2s-sync:2主2从同步刷盘(吞吐量会下降，但是消息更安全)，</li><li>2m-noslave:2主无从(单点故障)，然后还可以直接配置broker.conf，进行单点环境配置。</li><li>而dleger就是用来实现主从切换的。集群中的节点会基于Raft协议随机选举出一个leader，其他的就都是follower。通常正式环境都会采用这种方式来搭建集群。</li></ul></blockquote><p><img src="/images/RocketMQ/image-20211101224451742.png" alt="image-20211101224451742"></p><p><strong>我们这次采用2m-2s-async的方式搭建集群。</strong></p><hr><h3 id="配置第一组broker-a" tabindex="-1"><a class="header-anchor" href="#配置第一组broker-a" aria-hidden="true">#</a> 配置第一组broker-a</h3><h4 id="broker-a主节点" tabindex="-1"><a class="header-anchor" href="#broker-a主节点" aria-hidden="true">#</a> broker-a主节点</h4><p>在<strong>192.168.187.130</strong>上先配置borker-a的master节点。先配置2m-2s-async/broker-a.properties</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>\n<span class="token assign-left variable">brokerClusterName</span><span class="token operator">=</span>rocketmq-cluster\n<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。⭐⭐</span>\n<span class="token assign-left variable">brokerName</span><span class="token operator">=</span>broker-a\n<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>\n<span class="token assign-left variable">brokerId</span><span class="token operator">=</span><span class="token number">0</span>\n<span class="token comment">#nameServer地址，分号分割</span>\n<span class="token comment">#namesrvAddr=worker1:9876;worker2:9876;worker3:9876</span>\n<span class="token assign-left variable">namesrvAddr</span><span class="token operator">=</span><span class="token number">192.168</span>.187.135:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.130:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.132:9876\n<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数 ⭐⭐</span>\n<span class="token assign-left variable">defaultTopicQueueNums</span><span class="token operator">=</span><span class="token number">4</span>\n<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true\n<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateSubscriptionGroup</span><span class="token operator">=</span>true\n<span class="token comment">#Broker 对外服务的监听端口</span>\n<span class="token assign-left variable">listenPort</span><span class="token operator">=</span><span class="token number">10911</span>\n<span class="token comment">#删除文件时间点，默认凌晨 4点</span>\n<span class="token assign-left variable">deleteWhen</span><span class="token operator">=</span>04\n<span class="token comment">#文件保留时间，默认 48 小时</span>\n<span class="token assign-left variable">fileReservedTime</span><span class="token operator">=</span><span class="token number">120</span>\n<span class="token comment">#commitLog每个文件的大小默认1G</span>\n<span class="token assign-left variable">mapedFileSizeCommitLog</span><span class="token operator">=</span><span class="token number">1073741824</span>\n<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>\n<span class="token assign-left variable">mapedFileSizeConsumeQueue</span><span class="token operator">=</span><span class="token number">300000</span>\n<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>\n<span class="token comment">#redeleteHangedFileInterval=120000</span>\n<span class="token comment">#检测物理文件磁盘空间</span>\n<span class="token assign-left variable">diskMaxUsedSpaceRatio</span><span class="token operator">=</span><span class="token number">88</span>\n<span class="token comment">#存储路径</span>\n<span class="token assign-left variable">storePathRootDir</span><span class="token operator">=</span>/usr/rocketmq/store\n<span class="token comment">#commitLog 存储路径</span>\n<span class="token assign-left variable">storePathCommitLog</span><span class="token operator">=</span>/usr/rocketmq/store/commitlog\n<span class="token comment">#消费队列存储路径存储路径</span>\n<span class="token assign-left variable">storePathConsumeQueue</span><span class="token operator">=</span>/usr/rocketmq/store/consumequeue\n<span class="token comment">#消息索引存储路径</span>\n<span class="token assign-left variable">storePathIndex</span><span class="token operator">=</span>/usr/rocketmq/store/index\n<span class="token comment">#checkpoint 文件存储路径</span>\n<span class="token assign-left variable">storeCheckpoint</span><span class="token operator">=</span>/usr/rocketmq/store/checkpoint\n<span class="token comment">#abort 文件存储路径</span>\n<span class="token assign-left variable">abortFile</span><span class="token operator">=</span>/usr/rocketmq/store/abort\n<span class="token comment">#限制的消息大小</span>\n<span class="token assign-left variable">maxMessageSize</span><span class="token operator">=</span><span class="token number">65536</span>\n<span class="token comment">#flushCommitLogLeastPages=4</span>\n<span class="token comment">#flushConsumeQueueLeastPages=2</span>\n<span class="token comment">#flushCommitLogThoroughInterval=10000</span>\n<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>\n<span class="token comment">#Broker 的角色</span>\n<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>\n<span class="token comment">#- SYNC_MASTER 同步双写Master</span>\n<span class="token comment">#- SLAVE</span>\n<span class="token assign-left variable">brokerRole</span><span class="token operator">=</span>ASYNC_MASTER\n<span class="token comment">#刷盘方式</span>\n<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>\n<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>\n<span class="token assign-left variable">flushDiskType</span><span class="token operator">=</span>ASYNC_FLUSH\n<span class="token comment">#checkTransactionMessageEnable=false</span>\n<span class="token comment">#发消息线程池数量</span>\n<span class="token comment">#sendMessageThreadPoolNums=128</span>\n<span class="token comment">#拉消息线程池数量</span>\n<span class="token comment">#pullMessageThreadPoolNums=128</span>\n<span class="token comment"># 开启sql过滤</span>\n<span class="token assign-left variable">enablePropertyFilter</span><span class="token operator">=</span>true\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h4 id="broker-a从节点" tabindex="-1"><a class="header-anchor" href="#broker-a从节点" aria-hidden="true">#</a> broker-a从节点</h4><p>该节点对应的从节点在<strong>192.168.187.132</strong>上。修改2m-2s-async/broker-a-s.properties <strong>需要修改brokerId和brokerRole</strong></p><p>还有<strong>storePathRootDir和listenPort</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>\n<span class="token assign-left variable">brokerClusterName</span><span class="token operator">=</span>rocketmq-cluster\n<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。 </span>\n<span class="token assign-left variable">brokerName</span><span class="token operator">=</span>broker-a\n<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>\n<span class="token assign-left variable">brokerId</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token comment">#nameServer地址，分号分割</span>\n<span class="token comment">#namesrvAddr=worker1:9876;worker2:9876;worker3:9876</span>\n<span class="token assign-left variable">namesrvAddr</span><span class="token operator">=</span><span class="token number">192.168</span>.187.135:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.130:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.132:9876\n<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>\n<span class="token assign-left variable">defaultTopicQueueNums</span><span class="token operator">=</span><span class="token number">4</span>\n<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true\n<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateSubscriptionGroup</span><span class="token operator">=</span>true\n<span class="token comment">#Broker 对外服务的监听端口</span>\n<span class="token assign-left variable">listenPort</span><span class="token operator">=</span><span class="token number">11011</span>\n<span class="token comment">#删除文件时间点，默认凌晨 4点</span>\n<span class="token assign-left variable">deleteWhen</span><span class="token operator">=</span>04\n<span class="token comment">#文件保留时间，默认 48 小时</span>\n<span class="token assign-left variable">fileReservedTime</span><span class="token operator">=</span><span class="token number">120</span>\n<span class="token comment">#commitLog每个文件的大小默认1G</span>\n<span class="token assign-left variable">mapedFileSizeCommitLog</span><span class="token operator">=</span><span class="token number">1073741824</span>\n<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>\n<span class="token assign-left variable">mapedFileSizeConsumeQueue</span><span class="token operator">=</span><span class="token number">300000</span>\n<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>\n<span class="token comment">#redeleteHangedFileInterval=120000</span>\n<span class="token comment">#检测物理文件磁盘空间</span>\n<span class="token assign-left variable">diskMaxUsedSpaceRatio</span><span class="token operator">=</span><span class="token number">88</span>\n<span class="token comment">#存储路径</span>\n<span class="token assign-left variable">storePathRootDir</span><span class="token operator">=</span>/usr/rocketmq/storeSlave\n<span class="token comment">#commitLog 存储路径</span>\n<span class="token assign-left variable">storePathCommitLog</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/commitlog\n<span class="token comment">#消费队列存储路径存储路径</span>\n<span class="token assign-left variable">storePathConsumeQueue</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/consumequeue\n<span class="token comment">#消息索引存储路径</span>\n<span class="token assign-left variable">storePathIndex</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/index\n<span class="token comment">#checkpoint 文件存储路径</span>\n<span class="token assign-left variable">storeCheckpoint</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/checkpoint\n<span class="token comment">#abort 文件存储路径</span>\n<span class="token assign-left variable">abortFile</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/abort\n<span class="token comment">#限制的消息大小</span>\n<span class="token assign-left variable">maxMessageSize</span><span class="token operator">=</span><span class="token number">65536</span>\n<span class="token comment">#flushCommitLogLeastPages=4</span>\n<span class="token comment">#flushConsumeQueueLeastPages=2</span>\n<span class="token comment">#flushCommitLogThoroughInterval=10000</span>\n<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>\n<span class="token comment">#Broker 的角色</span>\n<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>\n<span class="token comment">#- SYNC_MASTER 同步双写Master</span>\n<span class="token comment">#- SLAVE</span>\n<span class="token assign-left variable">brokerRole</span><span class="token operator">=</span>SLAVE\n<span class="token comment">#刷盘方式</span>\n<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>\n<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>\n<span class="token assign-left variable">flushDiskType</span><span class="token operator">=</span>ASYNC_FLUSH\n<span class="token comment">#checkTransactionMessageEnable=false</span>\n<span class="token comment">#发消息线程池数量</span>\n<span class="token comment">#sendMessageThreadPoolNums=128</span>\n<span class="token comment">#拉消息线程池数量</span>\n<span class="token comment">#pullMessageThreadPoolNums=128</span>\n<span class="token comment"># 开启sql过滤</span>\n<span class="token assign-left variable">enablePropertyFilter</span><span class="token operator">=</span>true\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h3 id="配置第二组broker-b" tabindex="-1"><a class="header-anchor" href="#配置第二组broker-b" aria-hidden="true">#</a> 配置第二组Broker-b</h3><h4 id="broker-b主节点" tabindex="-1"><a class="header-anchor" href="#broker-b主节点" aria-hidden="true">#</a> broker-b主节点</h4><p>这一组broker的主节点在<strong>192.168.187.132</strong>上，所以需要配置worker3上的config/2m-2s-async/broker-b.properties</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>\n<span class="token assign-left variable">brokerClusterName</span><span class="token operator">=</span>rocketmq-cluster\n<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。</span>\n<span class="token assign-left variable">brokerName</span><span class="token operator">=</span>broker-b\n<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>\n<span class="token assign-left variable">brokerId</span><span class="token operator">=</span><span class="token number">0</span>\n<span class="token comment">#nameServer地址，分号分割</span>\n<span class="token comment">#namesrvAddr=worker1:9876;worker2:9876;worker3:9876</span>\n<span class="token assign-left variable">namesrvAddr</span><span class="token operator">=</span><span class="token number">192.168</span>.187.135:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.130:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.132:9876\n<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>\n<span class="token assign-left variable">defaultTopicQueueNums</span><span class="token operator">=</span><span class="token number">4</span>\n<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true\n<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateSubscriptionGroup</span><span class="token operator">=</span>true\n<span class="token comment">#Broker 对外服务的监听端口</span>\n<span class="token assign-left variable">listenPort</span><span class="token operator">=</span><span class="token number">10911</span>\n<span class="token comment">#删除文件时间点，默认凌晨 4点</span>\n<span class="token assign-left variable">deleteWhen</span><span class="token operator">=</span>04\n<span class="token comment">#文件保留时间，默认 48 小时</span>\n<span class="token assign-left variable">fileReservedTime</span><span class="token operator">=</span><span class="token number">120</span>\n<span class="token comment">#commitLog每个文件的大小默认1G</span>\n<span class="token assign-left variable">mapedFileSizeCommitLog</span><span class="token operator">=</span><span class="token number">1073741824</span>\n<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>\n<span class="token assign-left variable">mapedFileSizeConsumeQueue</span><span class="token operator">=</span><span class="token number">300000</span>\n<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>\n<span class="token comment">#redeleteHangedFileInterval=120000</span>\n<span class="token comment">#检测物理文件磁盘空间</span>\n<span class="token assign-left variable">diskMaxUsedSpaceRatio</span><span class="token operator">=</span><span class="token number">88</span>\n<span class="token comment">#存储路径</span>\n<span class="token assign-left variable">storePathRootDir</span><span class="token operator">=</span>/usr/rocketmq/store\n<span class="token comment">#commitLog 存储路径</span>\n<span class="token assign-left variable">storePathCommitLog</span><span class="token operator">=</span>/usr/rocketmq/store/commitlog\n<span class="token comment">#消费队列存储路径存储路径</span>\n<span class="token assign-left variable">storePathConsumeQueue</span><span class="token operator">=</span>/usr/rocketmq/store/consumequeue\n<span class="token comment">#消息索引存储路径</span>\n<span class="token assign-left variable">storePathIndex</span><span class="token operator">=</span>/usr/rocketmq/store/index\n<span class="token comment">#checkpoint 文件存储路径</span>\n<span class="token assign-left variable">storeCheckpoint</span><span class="token operator">=</span>/usr/rocketmq/store/checkpoint\n<span class="token comment">#abort 文件存储路径</span>\n<span class="token assign-left variable">abortFile</span><span class="token operator">=</span>/usr/rocketmq/store/abort\n<span class="token comment">#限制的消息大小</span>\n<span class="token assign-left variable">maxMessageSize</span><span class="token operator">=</span><span class="token number">65536</span>\n<span class="token comment">#flushCommitLogLeastPages=4</span>\n<span class="token comment">#flushConsumeQueueLeastPages=2</span>\n<span class="token comment">#flushCommitLogThoroughInterval=10000</span>\n<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>\n<span class="token comment">#Broker 的角色</span>\n<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>\n<span class="token comment">#- SYNC_MASTER 同步双写Master</span>\n<span class="token comment">#- SLAVE</span>\n<span class="token assign-left variable">brokerRole</span><span class="token operator">=</span>ASYNC_MASTER\n<span class="token comment">#刷盘方式</span>\n<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>\n<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>\n<span class="token assign-left variable">flushDiskType</span><span class="token operator">=</span>ASYNC_FLUSH\n<span class="token comment">#checkTransactionMessageEnable=false</span>\n<span class="token comment">#发消息线程池数量</span>\n<span class="token comment">#sendMessageThreadPoolNums=128</span>\n<span class="token comment">#拉消息线程池数量</span>\n<span class="token comment">#pullMessageThreadPoolNums=128</span>\n<span class="token comment"># 开启sql过滤</span>\n<span class="token assign-left variable">enablePropertyFilter</span><span class="token operator">=</span>true\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><hr><h4 id="broker-b从节点" tabindex="-1"><a class="header-anchor" href="#broker-b从节点" aria-hidden="true">#</a> broker-b从节点</h4><p>然后他对应的slave在<strong>192.168.187.130</strong>上，修改work2上的 <strong>conf/2m-2s-async/broker-b-s.properties</strong> 需要修改brokerId和brokerRole</p><p>还有<strong>storePathRootDir和listenPort</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>\n<span class="token assign-left variable">brokerClusterName</span><span class="token operator">=</span>rocketmq-cluster\n<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。</span>\n<span class="token assign-left variable">brokerName</span><span class="token operator">=</span>broker-b\n<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>\n<span class="token assign-left variable">brokerId</span><span class="token operator">=</span><span class="token number">1</span>\n<span class="token comment">#nameServer地址，分号分割</span>\n<span class="token comment">#namesrvAddr=worker1:9876;worker2:9876;worker3:9876</span>\n<span class="token assign-left variable">namesrvAddr</span><span class="token operator">=</span><span class="token number">192.168</span>.187.135:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.130:9876<span class="token punctuation">;</span><span class="token number">192.168</span>.187.132:9876\n<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>\n<span class="token assign-left variable">defaultTopicQueueNums</span><span class="token operator">=</span><span class="token number">4</span>\n<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true\n<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>\n<span class="token assign-left variable">autoCreateSubscriptionGroup</span><span class="token operator">=</span>true\n<span class="token comment">#Broker 对外服务的监听端口</span>\n<span class="token assign-left variable">listenPort</span><span class="token operator">=</span><span class="token number">11011</span>\n<span class="token comment">#删除文件时间点，默认凌晨 4点</span>\n<span class="token assign-left variable">deleteWhen</span><span class="token operator">=</span>04\n<span class="token comment">#文件保留时间，默认 48 小时</span>\n<span class="token assign-left variable">fileReservedTime</span><span class="token operator">=</span><span class="token number">120</span>\n<span class="token comment">#commitLog每个文件的大小默认1G</span>\n<span class="token assign-left variable">mapedFileSizeCommitLog</span><span class="token operator">=</span><span class="token number">1073741824</span>\n<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>\n<span class="token assign-left variable">mapedFileSizeConsumeQueue</span><span class="token operator">=</span><span class="token number">300000</span>\n<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>\n<span class="token comment">#redeleteHangedFileInterval=120000</span>\n<span class="token comment">#检测物理文件磁盘空间</span>\n<span class="token assign-left variable">diskMaxUsedSpaceRatio</span><span class="token operator">=</span><span class="token number">88</span>\n<span class="token comment">#存储路径</span>\n<span class="token assign-left variable">storePathRootDir</span><span class="token operator">=</span>/usr/rocketmq/storeSlave\n<span class="token comment">#commitLog 存储路径</span>\n<span class="token assign-left variable">storePathCommitLog</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/commitlog\n<span class="token comment">#消费队列存储路径存储路径</span>\n<span class="token assign-left variable">storePathConsumeQueue</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/consumequeue\n<span class="token comment">#消息索引存储路径</span>\n<span class="token assign-left variable">storePathIndex</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/index\n<span class="token comment">#checkpoint 文件存储路径</span>\n<span class="token assign-left variable">storeCheckpoint</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/checkpoint\n<span class="token comment">#abort 文件存储路径</span>\n<span class="token assign-left variable">abortFile</span><span class="token operator">=</span>/usr/rocketmq/storeSlave/abort\n<span class="token comment">#限制的消息大小</span>\n<span class="token assign-left variable">maxMessageSize</span><span class="token operator">=</span><span class="token number">65536</span>\n<span class="token comment">#flushCommitLogLeastPages=4</span>\n<span class="token comment">#flushConsumeQueueLeastPages=2</span>\n<span class="token comment">#flushCommitLogThoroughInterval=10000</span>\n<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>\n<span class="token comment">#Broker 的角色</span>\n<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>\n<span class="token comment">#- SYNC_MASTER 同步双写Master</span>\n<span class="token comment">#- SLAVE</span>\n<span class="token assign-left variable">brokerRole</span><span class="token operator">=</span>SLAVE\n<span class="token comment">#刷盘方式</span>\n<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>\n<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>\n<span class="token assign-left variable">flushDiskType</span><span class="token operator">=</span>ASYNC_FLUSH\n<span class="token comment">#checkTransactionMessageEnable=false</span>\n<span class="token comment">#发消息线程池数量</span>\n<span class="token comment">#sendMessageThreadPoolNums=128</span>\n<span class="token comment">#拉消息线程池数量</span>\n<span class="token comment">#pullMessageThreadPoolNums=128</span>\n<span class="token comment"># 开启sql过滤</span>\n<span class="token assign-left variable">enablePropertyFilter</span><span class="token operator">=</span>true\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><hr><p>这样broker就配置完成了。需要注意的配置项：</p><ol><li><p>同一机器上两个实例的store目录不能相同，否则会报错 Lock failed,MQ already started</p></li><li><p>同一机器上两个实例的listenPort也不能相同。否则会报端口占用的错</p></li><li><p>nameserver不需要进行配置，直接启动就行。这也<strong>看出nameserver是无状态的</strong>。</p></li></ol><h3 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h3><ol><li>所属集群名字，名字一样的节点就在同一个集群内</li><li>broker名字，名字一样的节点就是一组主从节点。</li><li>Broker 的角色 <ol><li>主 ASYNC_MASTER 异步复制Master ; SYNC_MASTER 同步双写Master</li><li>从SLAVE</li></ol></li></ol><hr><h2 id="启动rocketmq⭐" tabindex="-1"><a class="header-anchor" href="#启动rocketmq⭐" aria-hidden="true">#</a> 启动RocketMQ⭐</h2><p>启动就比较简单了，直接调用bin目录下的脚本就行。只是启动之前要注意看下他们的JVM内存配置，默认的配置都比较高。</p><h3 id="先启动nameserver" tabindex="-1"><a class="header-anchor" href="#先启动nameserver" aria-hidden="true">#</a> 先启动nameServer</h3><p>修改三个节点上的bin/runserver.sh，调整里面的jvm内存配置。找到下面这一行调整下内存</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -server -Xms512m -Xmx512m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><strong>直接在三个节点上启动nameServer</strong>。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">nohup</span> bin/mqnamesrv <span class="token operator">&amp;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>使用jps指令可以看到一个NamesrvStartup进程。</p><h3 id="再启动broker" tabindex="-1"><a class="header-anchor" href="#再启动broker" aria-hidden="true">#</a> 再启动broker</h3><p>启动broker是使用的mqbroker指令，只是<strong>注意启动broker时需要通过-c 指定对应的配置文件</strong>。</p><p>在**worker2（192.168.187.130）**上启动broker-a的master节点和broker-b的slave节点</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">nohup</span> bin/mqbroker <span class="token parameter variable">-c</span> conf/2m-2s-async/broker-a.properties <span class="token operator">&amp;</span>\n<span class="token function">nohup</span> bin/mqbroker <span class="token parameter variable">-c</span> conf/2m-2s-async/broker-b-s.properties <span class="token operator">&amp;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在**work3（192.168.187.132）**上启动broker-b的master节点和broker-a的slave节点</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">nohup</span> bin/mqbroker <span class="token parameter variable">-c</span> conf/2m-2s-async/broker-b.properties <span class="token operator">&amp;</span>\n<span class="token function">nohup</span> bin/mqbroker <span class="token parameter variable">-c</span> conf/2m-2s-async/broker-a-s.properties <span class="token operator">&amp;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>启动slave时，如果遇到报错 Lock failed,MQ already started ，那是因为有多个实例共用了同一个storePath造成的，这时就需要调整store的路径。</p></blockquote><hr><h2 id="关闭机器" tabindex="-1"><a class="header-anchor" href="#关闭机器" aria-hidden="true">#</a> 关闭机器</h2><p>在**work3（192.168.187.132）**上关闭broker-b的master节点和broker-a的slave节点</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sh</span> bin/mqshutdown broker\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="查看效果" tabindex="-1"><a class="header-anchor" href="#查看效果" aria-hidden="true">#</a> 查看效果</h2><p>任意一台机器运行该命令即可</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>mqadmin clusterList <span class="token parameter variable">-n</span> localhost:9876\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><img src="/images/RocketMQ/image-20211101233811455.png" alt="image-20211101233811455"></p>',62),r={},p=(0,a(66262).A)(r,[["render",function(s,n){return e}]])},66262:(s,n)=>{n.A=(s,n)=>{const a=s.__vccOpts||s;for(const[s,e]of n)a[s]=e;return a}}}]);