"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[84438],{98207:(s,n,a)=>{a.r(n),a.d(n,{data:()=>p});const p={key:"v-07893f4c",path:"/MySQL/28%20GTID.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/MySQL/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"GTID介绍",slug:"gtid介绍",children:[]},{level:2,title:"为什么有GTID",slug:"为什么有gtid",children:[]},{level:2,title:"GTID工作原理",slug:"gtid工作原理",children:[]},{level:2,title:"优点",slug:"优点",children:[]},{level:2,title:"缺点",slug:"缺点",children:[]},{level:2,title:"搭建环境测试",slug:"搭建环境测试",children:[{level:3,title:"测试复制的故障转移",slug:"测试复制的故障转移",children:[]},{level:3,title:"复制错误跳过",slug:"复制错误跳过",children:[]}]}],filePathRelative:"MySQL/28 GTID.md"}},76928:(s,n,a)=>{a.r(n),a.d(n,{default:()=>g});var p=a(20641);const e=(0,p.Lk)("h2",{id:"gtid介绍",tabindex:"-1"},[(0,p.Lk)("a",{class:"header-anchor",href:"#gtid介绍","aria-hidden":"true"},"#"),(0,p.eW)(" GTID介绍")],-1),o=(0,p.Lk)("blockquote",null,[(0,p.Lk)("p",null,"GTID(global transaction identifieds)全局事务标识：从MySQL 5.6.5 开始新增了一种基于 GTID 的复制方式。通过 GTID 保证了每个在主库上提交的事务在集群中有一个唯一的ID。这种方式强化了数据库的主备一致性，故障恢复以及容错能力。")],-1),t={href:"https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-lifecycle.html",target:"_blank",rel:"noopener noreferrer"},r=(0,p.Fv)('<div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>GTID = server_uuid:transaction_id\n示例：3E11FA47-71CA-11E1-9E33-C80AA9429562:1\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>GTID实际上是由UUID+TID组成的。其中UUID是一个MySQL实例的唯一标识。TID代表了该实例上已经提交的事务数量，并且随着事务提交单调递增。server_uuid 一般是发起事务的uuid, 标识了该事务执行的源节点，存储在数据目录中的auto.cnf文件中，transaction_id 是在该主库上生成的事务序列号，从1开始，1-2代表第二个事务；第1-n代表n个事务。 示例中 <code>3E11FA47-71CA-11E1-9E33-C80AA9429562</code> 是这个节点的<code>server_uuid</code>，1为这个节点上提交的第1个事务的事务号，如果提交了10个事务，GTID会是这样： <code>3E11FA47-71CA-11E1-9E33-C80AA9429562:1-10</code></p>',2),l={href:"https://cloud.tencent.com/product/cdb?from=20065&from_column=20065",target:"_blank",rel:"noopener noreferrer"},c=(0,p.Fv)('<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@k8s-master mysql<span class="token punctuation">]</span><span class="token comment"># pwd</span>\n/var/lib/mysql\n<span class="token punctuation">[</span>root@k8s-master mysql<span class="token punctuation">]</span><span class="token comment"># cat auto.cnf</span>\n<span class="token punctuation">[</span>auto<span class="token punctuation">]</span>\nserver-uuid<span class="token operator">=</span>5b95b05d-af9b-11ed-8760-000c29a45a0d\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>也可以通过命令查看</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@server_uuid</span><span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> @<span class="token variable">@server_uuid</span>                        <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> <span class="token number">5</span>b95b05d<span class="token operator">-</span>af9b<span class="token operator">-</span><span class="token number">11</span>ed<span class="token operator">-</span><span class="token number">8760</span><span class="token operator">-</span><span class="token number">000</span>c29a45a0d <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当在主库上提交事务或者被从库应用时，可以定位和追踪每一个事务，对DBA来说意义就很大了，我们可以适当的解放出来，不用手工去可以找偏移量的值了，而是通过<code>CHANGE MASTER TO MASTER_HOST=&#39;xxx&#39;, MASTER_AUTO_POSITION=1</code>的即可方便的搭建从库，在故障修复中也可以采用<code>MASTER_AUTO_POSITION=‘X’</code>的方式</p><h2 id="为什么有gtid" tabindex="-1"><a class="header-anchor" href="#为什么有gtid" aria-hidden="true">#</a> 为什么有GTID</h2><p><img src="/images/MySQL/image-20230510162910657.png" alt="image-20230510162910657"></p><ol><li><p>在主从复制中，尤其是半同步复制中， 由于Master 的dump进程一边要发送binlog给Slave，一边要等待Slave的ACK消息，这个过程是串行的，即前一个事物的ACK没有收到消息，那么后一个事物只能排队候着； 这样将会极大地影响性能；有了GTID后，SLAVE就直接可以通过数据流获得GTID信息，而且可以同步；</p></li><li><p>另外，主从故障切换中，如果一台MASTER down，需要提取拥有最新日志的SLAVE做MASTER，这个是很好判断，而有了GTID，就只要以GTID为准即可方便判断；而有了GTID后，SLAVE就不需要一直保存这bin-log 的文件名和Position了；只要启用MASTER_AUTO_POSITION即可。</p></li><li><p>当MASTER crash的时候，GTID有助于保证数据一致性，因为每个事物都对应唯一GTID，如果在恢复的时候某事物被重复提交，SLAVE会直接忽略；</p></li></ol><p>从架构设计的角度，GTID是一种很好的分布式ID实践方式，通常来说，<strong>分布式ID</strong>有两个基本要求：</p><p>1）全局唯一性</p><p>2）趋势递增</p><p>这个ID因为是全局唯一，所以在分布式环境中很容易识别，因为趋势递增，所以ID是具有相应的趋势规律，在必要的时候方便进行顺序提取，行业内适用较多的是基于Twitter的ID生成算法snowflake,所以换一个角度来理解GTID，其实是一种优雅的分布式设计。</p><h2 id="gtid工作原理" tabindex="-1"><a class="header-anchor" href="#gtid工作原理" aria-hidden="true">#</a> GTID工作原理</h2><p><img src="/images/MySQL/image-20230510174257121.png" alt="image-20230510174257121"></p><ol><li>master更新数据时，会在事务前产生GTID，一同记录到binlog日志中。</li><li>slave端的i/o 线程将变更的binlog，写入到本地的relay log中。</li><li>sql线程从relay log中获取GTID，然后对比slave端的binlog是否有记录。</li><li>如果有记录，说明该GTID的事务已经执行，slave会忽略。</li><li>如果没有记录，slave就会从relay log中执行该GTID的事务，并记录到binlog。</li><li>在解析过程中会判断是否有主键，如果没有就用二级索引，如果没有就用全部扫描。</li></ol><h2 id="优点" tabindex="-1"><a class="header-anchor" href="#优点" aria-hidden="true">#</a> 优点</h2>',15),k={href:"https://cloud.tencent.com/product/cvm?from=20065&from_column=20065",target:"_blank",rel:"noopener noreferrer"},u=(0,p.Lk)("li",null,[(0,p.Lk)("strong",null,"GTID是用来代替传统复制的方法，GTID复制与普通复制模式的最大不同就是不需要指定二进制文件名和位置")],-1),i=(0,p.Lk)("li",null,"减少手工干预和降低服务故障时间，当主机挂了之后通过软件从众多的备机中提升一台备机为主机",-1),b=(0,p.Fv)('<blockquote><p>搭建主从传统模式:需要指定二进制文件名和位置</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>CHANGE MASTER <span class="token keyword">TO</span>\nMASTER_HOST<span class="token operator">=</span><span class="token string">&#39;192.168.135.132&#39;</span><span class="token punctuation">,</span>       \nMASTER_PORT<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>\nMASTER_USER<span class="token operator">=</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>\nMASTER_PASSWORD<span class="token operator">=</span><span class="token string">&#39;Root.123456&#39;</span><span class="token punctuation">,</span>\nMASTER_LOG_FILE<span class="token operator">=</span><span class="token string">&#39;master-bin.000001&#39;</span><span class="token punctuation">,</span>\nMASTER_LOG_POS<span class="token operator">=</span><span class="token number">535</span><span class="token punctuation">,</span>\nGET_MASTER_PUBLIC_KEY<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>使用GTID搭建的主从，不需要指定需要指定二进制文件名和位置</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> change master <span class="token keyword">to</span> \n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_host<span class="token operator">=</span><span class="token string">&#39;192.168.197.128&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_user<span class="token operator">=</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_password<span class="token operator">=</span><span class="token string">&#39;Root.123456&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_port<span class="token operator">=</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_auto_position<span class="token operator">=</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="缺点" tabindex="-1"><a class="header-anchor" href="#缺点" aria-hidden="true">#</a> 缺点</h2><ol><li><p>不支持非事务引擎</p></li><li><p>不支持<code>create table ... select</code> 语句复制(主库直接报错)</p><p>原理：（ 会生成两个sql，一个是DDL创建表SQL，一个是insert into 插入数据的sql。 由于DDL会导致自动提交，所以这个sql至少需要两个GTID，但是GTID模式下，只能给这个sql生成一个GTID ）</p></li><li><p>不允许一个SQL同时更新一个事务引擎表和非事务引擎表</p></li><li><p>开启GTID需要重启（5.7除外）</p></li><li><p>对于create temporary table 和 drop temporary table语句不支持</p></li><li><p>不支持sql_slave_skip_counter</p></li></ol><h2 id="搭建环境测试" tabindex="-1"><a class="header-anchor" href="#搭建环境测试" aria-hidden="true">#</a> 搭建环境测试</h2><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>server1   <span class="token number">192.168</span><span class="token number">.197</span><span class="token number">.128</span>  <span class="token number">3306</span>   Master\nserver2   <span class="token number">192.168</span><span class="token number">.197</span><span class="token number">.137</span>  <span class="token number">3306</span>   Slave\nserver3   <span class="token number">192.168</span><span class="token number">.197</span><span class="token number">.136</span>  <span class="token number">3306</span>   Slave\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>配置参数,开启GTID需要启用这三个参数：</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># /etc/my.cnf</span>\ngtid_mode <span class="token operator">=</span> <span class="token keyword">on</span> \nenforce_gtid_consistency <span class="token operator">=</span> <span class="token number">1</span>\nlog_slave_updates   <span class="token operator">=</span> <span class="token number">1</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>主节点: 在主节点上创建复制用户</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">&#39;root&#39;</span><span class="token variable">@&#39;%&#39;</span> identified <span class="token keyword">by</span> <span class="token string">&#39;Root.123456&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><blockquote><p>从节点：搭建主从</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> change master <span class="token keyword">to</span> \n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_host<span class="token operator">=</span><span class="token string">&#39;192.168.197.128&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_user<span class="token operator">=</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_password<span class="token operator">=</span><span class="token string">&#39;Root.123456&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_port<span class="token operator">=</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_auto_position<span class="token operator">=</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>搭建成功后，在主节点197.128上查看从节点是否加入：</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> slave hosts<span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">-----------+------+------+-----------+--------------------------------------+</span>\n<span class="token operator">|</span> Server_id <span class="token operator">|</span> Host <span class="token operator">|</span> Port <span class="token operator">|</span> Master_id <span class="token operator">|</span> Slave_UUID                           <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">-----------+------+------+-----------+--------------------------------------+</span>\n<span class="token operator">|</span>         <span class="token number">3</span> <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token number">969488</span>f5<span class="token operator">-</span>c486<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span>adb7<span class="token operator">-</span><span class="token number">000</span>c29bf2c97 <span class="token operator">|</span>\n<span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token number">3306</span> <span class="token operator">|</span>          <span class="token operator">|</span> bb874065<span class="token operator">-</span>c485<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span><span class="token number">8</span>b52<span class="token operator">-</span><span class="token number">000</span>c2934472e <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">-----------+------+------+-----------+--------------------------------------+</span>\n <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>查看连接</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> processlist<span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">----+----------+------------------+------+------------------+------+---------------------------------------------------------------+------------------+</span>\n<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span>     <span class="token operator">|</span> Host             <span class="token operator">|</span> db   <span class="token operator">|</span> Command          <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State                                                         <span class="token operator">|</span> Info             <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">----+----------+------------------+------+------------------+------+---------------------------------------------------------------+------------------+</span>\n<span class="token operator">|</span>   <span class="token operator">|</span> root     <span class="token operator">|</span> localhost        <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query            <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">starting</span>                                                      <span class="token operator">|</span> <span class="token keyword">show</span> processlist <span class="token operator">|</span>\n<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> repluser <span class="token operator">|</span> work_NAT_4:<span class="token number">60051</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span>  <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> more updates <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>\n<span class="token operator">|</span>   <span class="token operator">|</span> repluser <span class="token operator">|</span> work_NAT_5: <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">5970</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> more updates <span class="token operator">|</span> <span class="token boolean">NULL</span>             <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">----+----------+------------------+------+------------------+------+---------------------------------------------------------------+------------------+</span>\n <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>三台测试环境的UUID分别是</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">197.128</span>\nmysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@server_uuid</span><span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> @<span class="token variable">@server_uuid</span>                        <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> bd0d<span class="token operator">-</span><span class="token number">8691</span><span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span>afd6<span class="token operator">-</span><span class="token number">4</span>c3e51db5828 <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\n<span class="token number">197.137</span>\nmysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@server_uuid</span><span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> @<span class="token variable">@server_uuid</span>                        <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> bb874065<span class="token operator">-</span>c485<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span><span class="token number">8</span>b52<span class="token operator">-</span><span class="token number">000</span>c2934472e <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\n<span class="token number">197.136</span>\nmysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@server_uuid</span><span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> @<span class="token variable">@server_uuid</span>                        <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n<span class="token operator">|</span> f5<span class="token operator">-</span>c486<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span>adb7<span class="token operator">-</span><span class="token number">000</span>c29bf2c97 <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------------------------+</span>\n <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="测试复制的故障转移" tabindex="-1"><a class="header-anchor" href="#测试复制的故障转移" aria-hidden="true">#</a> 测试复制的故障转移</h3><blockquote><p>首先将server 3的复制过程停掉</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> stop slave<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>在server 1上创建一些数据</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> yyy<span class="token punctuation">.</span>a<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> yyy<span class="token punctuation">.</span>b<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> yyy<span class="token punctuation">.</span>c<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>在另外两台上面查看数据结果：</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>server \nmysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token keyword">from</span> yyy<span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">---------------+</span>\n<span class="token operator">|</span> Tables_in_yyy <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">---------------+</span>\n<span class="token operator">|</span> a             <span class="token operator">|</span>\n<span class="token operator">|</span> b             <span class="token operator">|</span>\n<span class="token operator">|</span> c             <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">---------------+</span>\n <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\nserver \nmysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token keyword">from</span> yyy<span class="token punctuation">;</span>\nEmpty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>此时可以发现，server 2 的数据相比较server 3，它的数据比较新，此时停止server 1，模拟主服务器宕机：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token punctuation">[</span>root<span class="token variable">@work_NAT_1</span> init<span class="token punctuation">.</span>d<span class="token punctuation">]</span><span class="token comment"># service mysqld stop</span>\nShutting down MySQL<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                            <span class="token punctuation">[</span>  OK  <span class="token punctuation">]</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此时我们发现其他两个节点已经不能访问server 1了</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\\G\n<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>\n               Slave_IO_State: Reconnecting <span class="token keyword">after</span> a failed master event <span class="token keyword">read</span>\n                  Master_Host: <span class="token number">192.168</span><span class="token number">.197</span><span class="token number">.128</span>\n                  Master_User: repluser\n                  Master_Port: <span class="token number">3306</span>\n                Connect_Retry: <span class="token number">60</span>\n              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000006</span>\n          Read_Master_Log_Pos: <span class="token number">1364</span>\n               Relay_Log_File: mysql<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000004</span>\n                Relay_Log_Pos: <span class="token number">1569</span>\n        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000006</span>\n             Slave_IO_Running: Connecting\n            Slave_SQL_Running: Yes\n          Exec_Master_Log_Pos: <span class="token number">1364</span>\n              Relay_Log_Space: <span class="token number">2337</span> \n               Master_SSL_Key: \n        Seconds_Behind_Master: <span class="token boolean">NULL</span>\nMaster_SSL_Verify_Server_Cert: <span class="token keyword">No</span>\n                Last_IO_Errno: <span class="token number">2003</span>\n                Last_IO_Error: error reconnecting <span class="token keyword">to</span> master <span class="token string">&#39;root@192.168.197.128:3306&#39;</span> <span class="token operator">-</span> retry<span class="token operator">-</span><span class="token keyword">time</span>: <span class="token number">60</span>  retries: <span class="token number">1</span>\n               Last_SQL_Errno: <span class="token number">0</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>❤️我们需要设置server 2为server 3的主库，因为server 2的数据比较新。此时如果采用以前的办法，需要计算之前主库的log_pos和当前要设置成主库的log_pos，很有可能出错。所以出现了一些高可用性的工具如MHA，MMM等解决问题❤️</p><p>👍👍在MySQL5.6之后，很简单的解决了这个难题。因为同一事务的GTID在所有节点上的值一致，那么根据server3当前停止点的GTID就能定位到server2上的GTID，所以直接在server3上执行change即可</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> change master <span class="token keyword">to</span> \n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_host<span class="token operator">=</span><span class="token string">&#39;192.168.197.137&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_user<span class="token operator">=</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_password<span class="token operator">=</span><span class="token string">&#39;Root.123456&#39;</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_port<span class="token operator">=</span><span class="token punctuation">,</span>\n    <span class="token operator">-</span><span class="token operator">&gt;</span> master_auto_position<span class="token operator">=</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected<span class="token punctuation">,</span>  <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>此时查看server 3上的数据，可以发现，数据已经同步过来了;</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">start</span> slave<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token keyword">from</span> yyy<span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">---------------+</span>\n<span class="token operator">|</span> Tables_in_yyy <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">---------------+</span>\n<span class="token operator">|</span> a             <span class="token operator">|</span>\n<span class="token operator">|</span> b             <span class="token operator">|</span>\n<span class="token operator">|</span> c             <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">---------------+</span>\n <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="复制错误跳过" tabindex="-1"><a class="header-anchor" href="#复制错误跳过" aria-hidden="true">#</a> <strong>复制错误跳过</strong></h3><blockquote><p>上面的测试中，最终的结果是server 2是主节点，server 3是从节点，下面我们来验证复制错误跳过的办法</p><p>首先我们在从节点上执行一个drop的语句，让两边的数据不一致，如下：</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">--------------------+</span>\n<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------+</span>\n<span class="token operator">|</span> information_schema <span class="token operator">|</span>\n<span class="token operator">|</span> DBAs               <span class="token operator">|</span>\n<span class="token operator">|</span> customer           <span class="token operator">|</span>\n<span class="token operator">|</span> inc_db             <span class="token operator">|</span>\n<span class="token operator">|</span> mysql              <span class="token operator">|</span>\n<span class="token operator">|</span> performance_schema <span class="token operator">|</span>\n<span class="token operator">|</span> sys                <span class="token operator">|</span>\n<span class="token operator">|</span> testdb             <span class="token operator">|</span>\n<span class="token operator">|</span> yeyz               <span class="token operator">|</span>\n<span class="token operator">|</span> yyy                <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------+</span>\n <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">drop</span> <span class="token keyword">database</span> yyy<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>\n<span class="token operator">+</span><span class="token comment">--------------------+</span>\n<span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------+</span>\n<span class="token operator">|</span> information_schema <span class="token operator">|</span>\n<span class="token operator">|</span> DBAs               <span class="token operator">|</span>\n<span class="token operator">|</span> customer           <span class="token operator">|</span>\n<span class="token operator">|</span> inc_db             <span class="token operator">|</span>\n<span class="token operator">|</span> mysql              <span class="token operator">|</span>\n<span class="token operator">|</span> performance_schema <span class="token operator">|</span>\n<span class="token operator">|</span> sys                <span class="token operator">|</span>\n<span class="token operator">|</span> testdb             <span class="token operator">|</span>\n<span class="token operator">|</span> yeyz               <span class="token operator">|</span>\n<span class="token operator">+</span><span class="token comment">--------------------+</span>\n <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token punctuation">.</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><blockquote><p>然后我们在server 2上执行drop database yyy的操作，如下：</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">drop</span> <span class="token keyword">database</span> yyy<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div>',40),m={href:"https://cloud.tencent.com/solution/database?from=20065&from_column=20065",target:"_blank",rel:"noopener noreferrer"},d=(0,p.Fv)('<div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\\G\n<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>\n               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event\n                  Master_Host: <span class="token number">192.168</span><span class="token number">.197</span><span class="token number">.137</span>\n                  Master_User: repluser\n                  Master_Port: \n                Connect_Retry: \n              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>\n          Read_Master_Log_Pos: \n               Relay_Log_File: mysql<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span>\n                Relay_Log_Pos: \n        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span>\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: <span class="token keyword">No</span>\n                   Last_Errno: \n                   Last_Error: Error <span class="token string">&#39;Can&#39;</span>t <span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token string">&#39;yyy&#39;</span><span class="token punctuation">;</span> <span class="token keyword">database</span> doesn<span class="token string">&#39;t exist&#39;</span> <span class="token keyword">on</span> query<span class="token punctuation">.</span> <span class="token keyword">Default</span> <span class="token keyword">database</span>: <span class="token string">&#39;yyy&#39;</span><span class="token punctuation">.</span> Query: <span class="token string">&#39;drop database yyy&#39;</span>\n                 Skip_Counter: \n          Exec_Master_Log_Pos: \n              Relay_Log_Space: \n               Last_SQL_Error: Error <span class="token string">&#39;Can&#39;</span>t <span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token string">&#39;yyy&#39;</span><span class="token punctuation">;</span> <span class="token keyword">database</span> doesn<span class="token string">&#39;t exist&#39;</span> <span class="token keyword">on</span> query<span class="token punctuation">.</span> <span class="token keyword">Default</span> <span class="token keyword">database</span>: <span class="token string">&#39;yyy&#39;</span><span class="token punctuation">.</span> Query: <span class="token string">&#39;drop database yyy&#39;</span>\n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: \n                  Master_UUID: bb874065<span class="token operator">-</span>c485<span class="token operator">-</span>e8<span class="token operator">-</span>b52<span class="token operator">-</span>c2934472e\n             Master_Info_File: mysql<span class="token punctuation">.</span>slave_master_info\n           Retrieved_Gtid_Set: bd0d<span class="token comment">--e8-afd6-c3e51db5828:-,</span>\nbb874065<span class="token operator">-</span>c485<span class="token operator">-</span>e8<span class="token operator">-</span>b52<span class="token operator">-</span>c2934472e:\n            Executed_Gtid_Set: db33b36<span class="token operator">-</span>e51<span class="token operator">-</span>f<span class="token operator">-</span>a61d<span class="token operator">-</span>c99756e90155:<span class="token operator">-</span><span class="token punctuation">,</span>\nbd0d<span class="token comment">--e8-afd6-c3e51db5828:-,</span>\nf5<span class="token operator">-</span>c486<span class="token operator">-</span>e8<span class="token operator">-</span>adb7<span class="token operator">-</span>c29bf2c97:\n                Auto_Position: \n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><blockquote><p>当我们使用传统的方法来跳过这个错误的时候，会提示出GTID模式下不被允许，如下</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">global</span> sql_slave_skip_counter<span class="token operator">=</span><span class="token punctuation">;</span>\nERROR  <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: sql_slave_skip_counter can <span class="token operator">not</span> be <span class="token keyword">set</span> <span class="token keyword">when</span> the server <span class="token operator">is</span> running <span class="token keyword">with</span> @<span class="token variable">@GLOBAL.GTID_MODE</span> <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">.</span> Instead<span class="token punctuation">,</span> <span class="token keyword">for</span> each <span class="token keyword">transaction</span> that you want <span class="token keyword">to</span> skip<span class="token punctuation">,</span> generate an empty <span class="token keyword">transaction</span> <span class="token keyword">with</span> the same GTID <span class="token keyword">as</span> the <span class="token keyword">transaction</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>那么这种方式下应该如何跳过这个错误呢？</p><p>因为我们是通过GTID来进行复制的，也需要跳过这个事务从而继续复制，这个事务可以到主上的binlog里面查看：因为不知道找哪个GTID上出错，所以也不知道如何跳过哪个GTID。但是我们可以在show slave status里的信息里找到在执行Master里的POS:2012，现在我们拿着这个pos:2012去server 2的日志里面找，可以发现如下信息：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># at 2012</span>\n<span class="token comment">#190305 20:59:07 server id 2  end_log_pos 2073  GTID    last_committed=9        sequence_number=10      rbr_only=no</span>\n<span class="token keyword">SET</span> @<span class="token variable">@SESSION.GTID_NEXT</span><span class="token operator">=</span> <span class="token string">&#39;bb874065-c485-11e8-8b52-000c2934472e:1&#39;</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>\n<span class="token comment"># at 2073</span>\n<span class="token comment">#190305 20:59:07 server id 2  end_log_pos 2158  Query   thread_id=3     exec_time=0     error_code=0</span>\n<span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token comment">/*!*/</span><span class="token punctuation">;</span>\n<span class="token keyword">drop</span> <span class="token keyword">database</span> yyy\n<span class="token comment">/*!*/</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>我们可以看到GTID_NEXT的值是,然后我们通过下面的方法来重新恢复主从复制：</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> stop slave<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">session</span> gtid_next<span class="token operator">=</span><span class="token string">&#39;bb874065-c485-11e8-8b52-000c2934472e:1&#39;</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">begin</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">session</span> gtid_next<span class="token operator">=</span>automatic<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">start</span> slave<span class="token punctuation">;</span>\nQuery OK<span class="token punctuation">,</span>  <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n\nmysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\\G\n<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>\n               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event\n                  Master_Host: <span class="token number">192.168</span><span class="token number">.197</span><span class="token number">.137</span>\n                  Master_User: repluser\n                  Master_Port: <span class="token number">3306</span>\n                Connect_Retry: <span class="token number">60</span>\n              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000002</span>\n          Read_Master_Log_Pos: <span class="token number">2158</span>\n               Relay_Log_File: mysql<span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000003</span>\n                Relay_Log_Pos: <span class="token number">478</span>\n        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000002</span>\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n          Exec_Master_Log_Pos: <span class="token number">2158</span>\n              Relay_Log_Space: <span class="token number">1527</span>\n              Until_Condition: None\n             Master_Server_Id: <span class="token number">2</span>\n                  Master_UUID: bb874065<span class="token operator">-</span>c485<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span><span class="token number">8</span>b52<span class="token operator">-</span><span class="token number">000</span>c2934472e\n             Master_Info_File: mysql<span class="token punctuation">.</span>slave_master_info\n                    SQL_Delay: <span class="token number">0</span>\n          SQL_Remaining_Delay: <span class="token boolean">NULL</span>\n      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> more updates\n           Master_Retry_Count: \n           Retrieved_Gtid_Set: bd0d<span class="token operator">-</span><span class="token number">8691</span><span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span>afd6<span class="token operator">-</span><span class="token number">4</span>c3e51db5828:<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span>\nbb874065<span class="token operator">-</span>c485<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span><span class="token number">8</span>b52<span class="token operator">-</span><span class="token number">000</span>c2934472e:\n            Executed_Gtid_Set: db33b36<span class="token operator">-</span><span class="token number">0</span>e51<span class="token operator">-</span><span class="token number">409</span>f<span class="token operator">-</span>a61d<span class="token operator">-</span>c99756e90155:<span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">,</span>\nbd0d<span class="token operator">-</span><span class="token number">8691</span><span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span>afd6<span class="token operator">-</span><span class="token number">4</span>c3e51db5828:<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">,</span>\nf5<span class="token operator">-</span>c486<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span>adb7<span class="token operator">-</span><span class="token number">000</span>c29bf2c97:<span class="token punctuation">,</span>\nbb874065<span class="token operator">-</span>c485<span class="token operator">-</span><span class="token number">11</span>e8<span class="token operator">-</span><span class="token number">8</span>b52<span class="token operator">-</span><span class="token number">000</span>c2934472e:\n                Auto_Position: \n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div>',8),y={},g=(0,a(66262).A)(y,[["render",function(s,n){const a=(0,p.g2)("OutboundLink");return(0,p.uX)(),(0,p.CE)(p.FK,null,[e,o,(0,p.Lk)("p",null,[(0,p.Lk)("a",t,[(0,p.eW)("MySQL :: MySQL 5.7 Reference Manual :: 16.1.3.2 GTID Life Cycle"),(0,p.bF)(a)])]),r,(0,p.Lk)("blockquote",null,[(0,p.Lk)("p",null,[(0,p.eW)("GTID （server_uuid:transaction_id）分成两部分，一部分是服务的UUid,UUID保存在"),(0,p.Lk)("a",l,[(0,p.eW)("mysql"),(0,p.bF)(a)]),(0,p.eW)("数据目录的auto.cnf文件中,UUID是一个MySQL实例的唯一标识。TID代表了该实例上已经提交的事务数量")])]),c,(0,p.Lk)("ol",null,[(0,p.Lk)("li",null,[(0,p.eW)("一个事务对应一个唯一GTID，一个GTID在一个"),(0,p.Lk)("a",k,[(0,p.eW)("服务器"),(0,p.bF)(a)]),(0,p.eW)("上只会执行一次")]),u,i]),b,(0,p.Lk)("blockquote",null,[(0,p.Lk)("p",null,[(0,p.eW)("此时我们看到server 3上已经出现了主从不同步的错误警告，因为它上面并没有yyy的"),(0,p.Lk)("a",m,[(0,p.eW)("数据库"),(0,p.bF)(a)]),(0,p.eW)("(前一步已经删除)，错误情况如下;")])]),d],64)}]])},66262:(s,n)=>{n.A=(s,n)=>{const a=s.__vccOpts||s;for(const[s,p]of n)a[s]=p;return a}}}]);