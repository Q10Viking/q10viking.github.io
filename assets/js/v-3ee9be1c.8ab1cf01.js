"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[1449],{73398:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-3ee9be1c",path:"/Ribbon/04%20Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/Ribbon/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"Ribbon负载均衡策略",slug:"ribbon负载均衡策略",children:[]},{level:2,title:"使用NacosRule",slug:"使用nacosrule",children:[{level:3,title:"NacosRule集群优先的实现",slug:"nacosrule集群优先的实现",children:[]},{level:3,title:"全局配置",slug:"全局配置",children:[]},{level:3,title:"局部配置",slug:"局部配置",children:[]}]}],filePathRelative:"Ribbon/04 Ribbon负载均衡策略.md"}},8903:(n,s,a)=>{a.r(s),a.d(s,{default:()=>p});const e=(0,a(20641).Fv)('<h2 id="ribbon负载均衡策略" tabindex="-1"><a class="header-anchor" href="#ribbon负载均衡策略" aria-hidden="true">#</a> Ribbon负载均衡策略</h2><p><img src="/images/ribbon/13573.png" alt="img"></p><ol><li><strong>RandomRule</strong>： 随机选择一个Server。</li><li><strong>RetryRule</strong>： 对选定的负载均衡策略机上重试机制，在一个配置时间段内当选择Server不成功，则一直尝试使用subRule的方式选择一个可用的server。</li><li><strong>RoundRobinRule</strong>： 轮询选择， 轮询index，选择index对应位置的Server。</li><li><strong>AvailabilityFilteringRule</strong>： 过滤掉一直连接失败的被标记为circuit tripped的后端Server，并过滤掉那些高并发的后端Server或者使用一个AvailabilityPredicate来包含过滤server的逻辑，其实就是检查status里记录的各个Server的运行状态。</li><li><strong>BestAvailableRule</strong>： 选择一个最小的并发请求的Server，逐个考察Server，如果Server被tripped了，则跳过。</li><li><strong>WeightedResponseTimeRule</strong>： 根据响应时间加权，响应时间越长，权重越小，被选中的可能性越低。</li><li><strong>ZoneAvoidanceRule</strong>： 默认的负载均衡策略，即复合判断Server所在区域的性能和Server的可用性选择Server，在没有区域的环境下，类似于轮询(RandomRule)</li><li><strong>NacosRule:</strong> 同集群优先调用</li></ol><h2 id="使用nacosrule" tabindex="-1"><a class="header-anchor" href="#使用nacosrule" aria-hidden="true">#</a> 使用NacosRule</h2><h3 id="nacosrule集群优先的实现" tabindex="-1"><a class="header-anchor" href="#nacosrule集群优先的实现" aria-hidden="true">#</a> NacosRule集群优先的实现</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instance</span><span class="token punctuation">&gt;</span></span> sameClusterInstances <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\t\t\t\t\t\t<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>instance <span class="token operator">-&gt;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span>\n\t\t\t\t\t\t\t\tinstance<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\t\t\t\t\t\t<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="全局配置" tabindex="-1"><a class="header-anchor" href="#全局配置" aria-hidden="true">#</a> 全局配置</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonConfig</span> <span class="token punctuation">{</span>\n\n    <span class="token doc-comment comment">/**\n     * 全局配置\n     * 指定负载均衡策略\n     * <span class="token keyword">@return</span>\n     */</span>\n    <span class="token annotation punctuation">@Bean</span>\n    <span class="token keyword">public</span> <span class="token class-name">IRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 指定使用Nacos提供的负载均衡策略（优先调用同一集群的实例，基于随机权重）</span>\n        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="局部配置" tabindex="-1"><a class="header-anchor" href="#局部配置" aria-hidden="true">#</a> <strong>局部配置</strong></h3><p>调用指定微服务提供的服务时，使用对应的负载均衡算法</p><p>修改application.yml</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>\n  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8010</span>\n<span class="token key atrule">spring</span><span class="token punctuation">:</span>\n  <span class="token key atrule">application</span><span class="token punctuation">:</span>\n    <span class="token key atrule">name</span><span class="token punctuation">:</span> mall<span class="token punctuation">-</span>user\n  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>\n    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.88.1<span class="token punctuation">:</span><span class="token number">8848</span>\n      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>\n        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> BJ\n<span class="token comment"># 被调用微服务名称</span>\n<span class="token key atrule">mall-order</span><span class="token punctuation">:</span>\n  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>\n  \t<span class="token comment"># 指定负载均衡策略</span>\n    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="/images/ribbon/image-20210822142146975.png" alt="image-20210822142146975"></p>',13),t={},p=(0,a(66262).A)(t,[["render",function(n,s){return e}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}}}]);