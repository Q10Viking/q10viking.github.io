"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[22972],{56281:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-7e32ddba",path:"/RocketMQ/14%20%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/RocketMQ/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"事务消息",slug:"事务消息",children:[]},{level:2,title:"事务消费内部机制",slug:"事务消费内部机制",children:[]}],filePathRelative:"RocketMQ/14 事务消息.md"}},37556:(n,s,a)=>{a.r(s),a.d(s,{default:()=>u});var t=a(20641);const e=(0,t.Lk)("h2",{id:"事务消息",tabindex:"-1"},[(0,t.Lk)("a",{class:"header-anchor",href:"#事务消息","aria-hidden":"true"},"#"),(0,t.eW)(" 事务消息")],-1),k=(0,t.Lk)("div",{class:"custom-container tip"},[(0,t.Lk)("p",{class:"custom-container-title"},"TIP"),(0,t.Lk)("ul",null,[(0,t.Lk)("li",null,"事务消息是在分布式系统中保证最终一致性的两阶段提交的消息实现。他可以保证本地事务执行与消息发送两个操作的原子性，也就是这两个操作一起成功或者一起失败"),(0,t.Lk)("li",null,"事务消息只保证消息发送者的本地事务与发消息这两个操作的原子性，因此，事务消息的示例只涉及到消息发送者，对于消息消费者来说，并没有什么特别的。")])],-1),c=(0,t.Lk)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Lk)("pre",{class:"language-java"},[(0,t.Lk)("code",null,[(0,t.Lk)("span",{class:"token keyword"},"public"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"class"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"TransactionProducer"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token keyword"},"public"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"static"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"void"),(0,t.eW)(),(0,t.Lk)("span",{class:"token function"},"main"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.Lk)("span",{class:"token punctuation"},"["),(0,t.Lk)("span",{class:"token punctuation"},"]"),(0,t.eW)(" args"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"throws"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"MQClientException"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"InterruptedException"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"TransactionListener"),(0,t.eW)(" transactionListener "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"TransactionListenerImpl"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"TransactionMQProducer"),(0,t.eW)(" producer "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"TransactionMQProducer"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token string"},'"transaction_producer_group"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        producer"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"setNamesrvAddr"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"Addr"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"NAME_SERVER_ADDR"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        producer"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"setTransactionListener"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("transactionListener"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"ExecutorService"),(0,t.eW)(" executorService "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"ThreadPoolExecutor"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token number"},"2"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"5"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"100"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"TimeUnit"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"SECONDS"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)("\n                "),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"ArrayBlockingQueue"),(0,t.Lk)("span",{class:"token generics"},[(0,t.Lk)("span",{class:"token punctuation"},"<"),(0,t.Lk)("span",{class:"token class-name"},"Runnable"),(0,t.Lk)("span",{class:"token punctuation"},">")]),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token number"},"2000"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"ThreadFactory"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"public"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.eW)(),(0,t.Lk)("span",{class:"token function"},"newThread"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"Runnable"),(0,t.eW)(" r"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n                "),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.eW)(" thread "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("r"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n                thread"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"setName"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token string"},'"hzz-client-transaction-msg-check-thread"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n                "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(" thread"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        producer"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"setExecutorService"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("executorService"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        producer"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"start"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.Lk)("span",{class:"token punctuation"},"["),(0,t.Lk)("span",{class:"token punctuation"},"]"),(0,t.eW)(" tags "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.Lk)("span",{class:"token punctuation"},"["),(0,t.Lk)("span",{class:"token punctuation"},"]"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.Lk)("span",{class:"token string"},'"TagA"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"TagB"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"TagC"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"TagD"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"TagE"'),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token keyword"},"for"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token keyword"},"int"),(0,t.eW)(" i "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"0"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)(" i "),(0,t.Lk)("span",{class:"token operator"},"<"),(0,t.eW)(),(0,t.Lk)("span",{class:"token number"},"10"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)(" i"),(0,t.Lk)("span",{class:"token operator"},"++"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"try"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n                "),(0,t.Lk)("span",{class:"token class-name"},"Message"),(0,t.eW)(" msg "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)("\n                        "),(0,t.Lk)("span",{class:"token keyword"},"new"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"Message"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token string"},'"transaction_topic"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(" tags"),(0,t.Lk)("span",{class:"token punctuation"},"["),(0,t.eW)("i "),(0,t.Lk)("span",{class:"token operator"},"%"),(0,t.eW)(" tags"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.eW)("length"),(0,t.Lk)("span",{class:"token punctuation"},"]"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token string"},'"KEY"'),(0,t.eW)(),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.eW)(" i"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)("\n                                "),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token string"},'"Hello RocketMQ "'),(0,t.eW)(),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.eW)(" i"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"getBytes"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"RemotingHelper"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"DEFAULT_CHARSET"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n                "),(0,t.Lk)("span",{class:"token class-name"},"SendResult"),(0,t.eW)(" sendResult "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(" producer"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"sendMessageInTransaction"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("msg"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"null"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n                "),(0,t.Lk)("span",{class:"token class-name"},"System"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.eW)("out"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"printf"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token string"},'"%s%n"'),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(" sendResult"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n\n                "),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"sleep"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token number"},"10"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"catch"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"MQClientException"),(0,t.eW)(),(0,t.Lk)("span",{class:"token operator"},"|"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"UnsupportedEncodingException"),(0,t.eW)(" e"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n                e"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"printStackTrace"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"sleep"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token number"},"500_000"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        producer"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"shutdown"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n")])]),(0,t.Lk)("div",{class:"line-numbers"},[(0,t.Lk)("span",{class:"line-number"},"1"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"2"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"3"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"4"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"5"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"6"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"7"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"8"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"9"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"10"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"11"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"12"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"13"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"14"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"15"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"16"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"17"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"18"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"19"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"20"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"21"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"22"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"23"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"24"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"25"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"26"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"27"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"28"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"29"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"30"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"31"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"32"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"33"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"34"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"35"),(0,t.Lk)("br")])],-1),o=(0,t.Lk)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Lk)("pre",{class:"language-java"},[(0,t.Lk)("code",null,[(0,t.Lk)("span",{class:"token keyword"},"public"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"class"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"TransactionListenerImpl"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"implements"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"TransactionListener"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token keyword"},"public"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.eW)(),(0,t.Lk)("span",{class:"token function"},"executeLocalTransaction"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"Message"),(0,t.eW)(" msg"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"Object"),(0,t.eW)(" arg"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.eW)(" threadName "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"currentThread"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"getName"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.eW)(" tags "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(" msg"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"getTags"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token keyword"},"if"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"StringUtils"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"contains"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("tags"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.Lk)("span",{class:"token string"},'"TagA"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"COMMIT_MESSAGE"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.Lk)("span",{class:"token keyword"},"else"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"if"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"StringUtils"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"contains"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("tags"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.Lk)("span",{class:"token string"},'"TagB"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"ROLLBACK_MESSAGE"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.Lk)("span",{class:"token keyword"},"else"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"UNKNOW"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n\n    "),(0,t.Lk)("span",{class:"token annotation punctuation"},"@Override"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token keyword"},"public"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.eW)(),(0,t.Lk)("span",{class:"token function"},"checkLocalTransaction"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"MessageExt"),(0,t.eW)(" msg"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.eW)(),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.eW)(" threadName "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"Thread"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"currentThread"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"getName"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token class-name"},"String"),(0,t.eW)(" tags "),(0,t.Lk)("span",{class:"token operator"},"="),(0,t.eW)(" msg"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"getTags"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token keyword"},"if"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"StringUtils"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"contains"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("tags"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.Lk)("span",{class:"token string"},'"TagC"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token class-name"},"System"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.eW)("out"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"println"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("threadName"),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.Lk)("span",{class:"token string"},'" TagC COMMIT_MESSAGE"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"COMMIT_MESSAGE"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.Lk)("span",{class:"token keyword"},"else"),(0,t.eW)(),(0,t.Lk)("span",{class:"token keyword"},"if"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.Lk)("span",{class:"token class-name"},"StringUtils"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"contains"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("tags"),(0,t.Lk)("span",{class:"token punctuation"},","),(0,t.Lk)("span",{class:"token string"},'"TagD"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token class-name"},"System"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.eW)("out"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"println"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("threadName"),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.Lk)("span",{class:"token string"},'" TagD ROLLBACK_MESSAGE"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"ROLLBACK_MESSAGE"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.Lk)("span",{class:"token keyword"},"else"),(0,t.Lk)("span",{class:"token punctuation"},"{"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token class-name"},"System"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.eW)("out"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token function"},"println"),(0,t.Lk)("span",{class:"token punctuation"},"("),(0,t.eW)("threadName"),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.Lk)("span",{class:"token string"},'" "'),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.eW)("tags"),(0,t.Lk)("span",{class:"token operator"},"+"),(0,t.Lk)("span",{class:"token string"},'" UNKNOW"'),(0,t.Lk)("span",{class:"token punctuation"},")"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n            "),(0,t.Lk)("span",{class:"token keyword"},"return"),(0,t.eW)(),(0,t.Lk)("span",{class:"token class-name"},"LocalTransactionState"),(0,t.Lk)("span",{class:"token punctuation"},"."),(0,t.Lk)("span",{class:"token constant"},"UNKNOW"),(0,t.Lk)("span",{class:"token punctuation"},";"),(0,t.eW)("\n        "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n    "),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n"),(0,t.Lk)("span",{class:"token punctuation"},"}"),(0,t.eW)("\n")])]),(0,t.Lk)("div",{class:"line-numbers"},[(0,t.Lk)("span",{class:"line-number"},"1"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"2"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"3"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"4"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"5"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"6"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"7"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"8"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"9"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"10"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"11"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"12"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"13"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"14"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"15"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"16"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"17"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"18"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"19"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"20"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"21"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"22"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"23"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"24"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"25"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"26"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"27"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"28"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"29"),(0,t.Lk)("br"),(0,t.Lk)("span",{class:"line-number"},"30"),(0,t.Lk)("br")])],-1),p=(0,t.Fv)('<blockquote><p>最后只有TagA和TagC的消息成功发送。TagB和TagD被回滚丢弃了，TagE一直在检查中,默认检查15次</p></blockquote><p><img src="/images/RocketMQ/image-20220608122519354.png" alt="image-20220608122519354"></p><p><img src="/images/RocketMQ/image-20220608123324421.png" alt="image-20220608123324421"></p><h2 id="事务消费内部机制" tabindex="-1"><a class="header-anchor" href="#事务消费内部机制" aria-hidden="true">#</a> 事务消费内部机制</h2><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>会将消息转为一个half半消息，并存入RocketMQ内部的一个 RMQ_SYS_TRANS_HALF_TOPIC 这个Topic，这样对消费者是不可见的。再经过一系列事务检查通过后，再将消息转存到目标Topic，这样对消费者就可见了。</p></div><p><img src="/images/RocketMQ/AB6461C3F74A49.jpg" alt="image"></p>',6),l={},u=(0,a(66262).A)(l,[["render",function(n,s){const a=(0,t.g2)("CodeGroupItem"),l=(0,t.g2)("CodeGroup");return(0,t.uX)(),(0,t.CE)(t.FK,null,[e,k,(0,t.bF)(l,null,{default:(0,t.k6)((()=>[(0,t.bF)(a,{title:"TransactionProducer"},{default:(0,t.k6)((()=>[c])),_:1}),(0,t.bF)(a,{title:"TransactionListenerImpl"},{default:(0,t.k6)((()=>[o])),_:1})])),_:1}),p],64)}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}}}]);