<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/images/favicon-32x32.png"><title>静默のBlog</title><meta name="description" content="静默的Vuepress Blog">
    <link rel="preload" href="/assets/js/runtime~app.2c87fbe0.js" as="script"><link rel="preload" href="/assets/css/styles.b779b927.css" as="style"><link rel="preload" href="/assets/js/95615.aba5921d.js" as="script"><link rel="preload" href="/assets/js/app.4aafd1f6.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b779b927.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">静默のBlog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item"></p><ul class=""><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#rebalance简介" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Rebalance简介"><!--[--><!--]--> Rebalance简介 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#broker端rebalance协调机制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Broker端Rebalance协调机制"><!--[--><!--]--> Broker端Rebalance协调机制 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#队列信息变化" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="队列信息变化"><!--[--><!--]--> 队列信息变化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#消费者组信息变化" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="消费者组信息变化"><!--[--><!--]--> 消费者组信息变化 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#consumer-rebalance机制" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Consumer Rebalance机制"><!--[--><!--]--> Consumer Rebalance机制 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#rebalance触发时机" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Rebalance触发时机"><!--[--><!--]--> Rebalance触发时机 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#单个消费者rebalance流程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="单个消费者Rebalance流程"><!--[--><!--]--> 单个消费者Rebalance流程 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#整体介绍" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="整体介绍"><!--[--><!--]--> 整体介绍 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#单个topic的rebalance流程" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="单个Topic的Rebalance流程"><!--[--><!--]--> 单个Topic的Rebalance流程 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/RocketMQ/26%20Reblance%E6%9C%BA%E5%88%B6.html#参考" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="参考"><!--[--><!--]--> 参考 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="rebalance简介" tabindex="-1"><a class="header-anchor" href="#rebalance简介" aria-hidden="true">#</a> Rebalance简介</h2><p>Rebalance(再均衡)机制指的是：将一个Topic下的多个队列(或称之为分区)，在同一个消费者组(consumer group)下的多个消费者实例(consumer instance)之间进行重新分配。</p><p>Rebalance机制本意是为了提升消息的并行处理能力。例如，一个Topic下5个队列，在只有1个消费者的情况下，那么这个消费者将负责处理这5个队列的消息。如果此时我们增加一个消费者，那么可以给其中一个消费者分配2个队列，给另一个分配3个队列，从而提升消息的并行处理能力。如下图：</p><p><img src="/images/RocketMQ/863118-20220212222125424-1455025977.png" alt="image"></p><p>但是Rebalance机制也存在明显的限制与危害。</p><p><code>Rebalance限制</code>：由于一个队列最多分配给一个消费者，因此当某个消费者组下的消费者实例数量大于队列的数量时，多余的消费者实例将分配不到任何队列。</p><p><code>Rebalance危害</code>： 除了以上限制，更加严重的是，在发生Rebalance时，存在着一些危害，如下所述：</p><ul><li><code>消费暂停</code>：考虑在只有Consumer 1的情况下，其负责消费所有5个队列；在新增Consumer 2，触发Rebalance时，需要分配2个队列给其消费。那么Consumer 1就需要停止这2个队列的消费，等到这两个队列分配给Consumer 2后，这两个队列才能继续被消费。</li><li><code>重复消费</code>：Consumer 2 在消费分配给自己的2个队列时，必须接着从Consumer 1之前已经消费到的offset继续开始消费。然而默认情况下，offset是异步提交的，如consumer 1当前消费到offset为10，但是异步提交给broker的offset为8；那么如果consumer 2从8的offset开始消费，那么就会有2条消息重复。也就是说，Consumer 2 并不会等待Consumer1提交完offset后，再进行Rebalance，因此提交间隔越长，可能造成的重复消费就越多。</li><li><code>消费突刺</code>：由于rebalance可能导致重复消费，如果需要重复消费的消息过多；或者因为rebalance暂停时间过长，导致积压了部分消息。那么都有可能导致在rebalance结束之后瞬间可能需要消费很多消息,(<strong>造成了消息积压</strong>)。</li></ul><p>基于Rebalance可能会给业务造成的负面影响，我们有必要对其内部原理进行深入剖析，以便于问题排查。我们将从Broker端和Consumer端两个角度来进行说明。</p><ul><li>Broker端主要负责Rebalance元数据维护，以及通知机制，在整个消费者组Rebalance过程中<strong>扮演协调者</strong>的作用</li><li>而Consumer端分析，主要聚焦于单个Consumer的Rebalance流程。</li></ul><h2 id="broker端rebalance协调机制" tabindex="-1"><a class="header-anchor" href="#broker端rebalance协调机制" aria-hidden="true">#</a> Broker端Rebalance协调机制</h2><p>从本质上来说，触发Rebalance的根本因素无非是两个：</p><ol><li>订阅Topic的队列数量变化</li><li>消费者组信息变化。导致二者发生变化的典型场景如下所示：</li></ol><table><thead><tr><th style="text-align:left;">队列信息变化</th><th style="text-align:left;">典型场景：broker宕机、broker升级等运维操作、队列扩容/缩容</th></tr></thead><tbody><tr><td style="text-align:left;">消费者组信息变化</td><td style="text-align:left;">典型场景：日常发布过程中的停止与启动、消费者异常宕机、网络异常导致消费者与Broker断开连接、主动进行消费者数量扩容/缩容、Topic订阅信息发生变化</td></tr></tbody></table><p>将队列信息和消费者组信息称之为Rebalance元数据，Broker负责维护这些元数据，并在二者信息发生变化时，以某种通知机制告诉消费者组下所有实例，需要进行Rebalance。从这个角度来说，Broker在Rebalance过程中，是一个协调者的角色。 在Broker内部，通过元数据管理器维护了Rebalance元数据信息，如下图所示：</p><p><img src="/images/RocketMQ/863118-20220212222616330-1754495023.png" alt="image"></p><p>这些管理器，内部实现都是一个Map。其中：</p><ul><li><p><code>队列信息</code>：由<code>TopicConfigManager</code>维护。Map 的key是Topic名称，Value是TopicConfig。Broker通过实时的或者周期性的上报自己的Topic配置信息给NameServer，在NameServer组装成Topic的完整路由信息。消费者定时向NameServer定时拉取最新路由信息，以实现间接通知，当发现队列信息变化，触发Rebalance。</p></li><li><p><code>消费者组信息</code>：由<code>ConsumerManager</code>、<code>ConsumerOffsetManager</code>、<code>SubscriptionGroupManager</code>三者共同维护。</p><ul><li>ConsumerManager维护了消费者组订阅信息，以及消费者组下当前的消费者实例信息，当消费者组的订阅信息或者实例发生变化，Broker都会主动给所有消费者实例发送通知，触发Rebalance。</li><li>而在Rebalance时，消费者需要从ConsumerOffsetManager查询应该从那个位置继续开始消费。</li><li>SubscriptionGroupManager主要是维护消费者组的一些附加信息，方便运维。</li></ul></li></ul><h3 id="队列信息变化" tabindex="-1"><a class="header-anchor" href="#队列信息变化" aria-hidden="true">#</a> 队列信息变化</h3><p>队列信息通过Broker内的TopicConfigManager来维护，每个Broker都会将自己的信息上报给NameServer，由NameServer组装成完整的Topic路由信息。</p><p>通常情况下，一个Topic下的队列数量不会频繁的变化，但是如果遇到，Topic队列数量扩/缩容，、broker日常运维时的停止/启动或者broker异常宕机，也有可能导致队列数量发生变化。</p><p>这里我们重点讲一下为什么broker异常停止/宕机会导致数量变化。一些读者可能会认为创建Topic时，已经明确指定了队列的数量，那么之后不论怎样，队列的数量信息都不会发生变化，这是一种典型误解。</p><p>下图展示了一个RocketMQ集群双主部署模式下，某个broker宕机后，Topic路由信息的变化。</p><p><img src="/images/RocketMQ/863118-20220212222951003-1231054740.png" alt="image"></p><p>可以看到，在宕机前，主题TopicX下队列分布在broker-a和broker-b两个broker上，每个broker上各有8个队列。当broker-a宕机后，其路由信息会被移除，此时我们就只能看到TopicX在broker-b上的路由信息。</p><p>因此，在RocketMQ中，Topic的路由信息实际上是动态变化的。不论是停止/启动/扩容导致的所有变化最终都会上报给NameServer。客户端可以给NameServer发送<code>GET_ROUTEINTO_BY_TOPIC</code>请求，来获得某个Topic的完整路由信息。如果发现队列信息发生变化，则触发Reabalance。</p><h3 id="消费者组信息变化" tabindex="-1"><a class="header-anchor" href="#消费者组信息变化" aria-hidden="true">#</a> 消费者组信息变化</h3><p>Rebalance的另外一个条件：消费者组信息，由ConsumerManager、ConsumerOffsetManager、SubscriptionGroupManager三个组件共同维护。</p><h4 id="consumermanager" tabindex="-1"><a class="header-anchor" href="#consumermanager" aria-hidden="true">#</a> ConsumerManager</h4><p>ConsumerManager是最重要的一个消费者组元数据管理器，其<strong>维护了某个消费者组的订阅信息，以及所有消费者实例的详细信息</strong>，并在发生变化时提供通知机制。</p><ul><li><code>数据添加</code>：客户端通过发送HEART_BEAT请求给Broker，将自己添加到ConsumerManager中维护的某个消费者组中。需要注意的是，<strong>每个Consumer都会向所有的Broker进行心跳</strong>，因此每个Broker都维护了所有消费者的信息。</li><li><code>数据删除</code>：客户端正常停止时，发送UNREGISTER_CLIENT请求，将自己从ConsumerManager移除；此外在发生网络异常时，Broker也会主动将消费者从ConsumerManager中移除。</li><li><code>数据查询</code>：消费者可以向任意一个Broker发送GET_CONSUMER_LIST_BY_GROUP请求，来获得一个消费者组下的所有消费者实例信息。</li></ul><p>我们可以通过mqadmin命令行工具的consumerConnection子命令，来查看ConsumerManager中，某个消费者的信息，如：</p><p><img src="/images/RocketMQ/863118-20220212233740537-168813331.png" alt="image"></p><p>输出主要分为2个部分：</p><ol><li>消费者组实例信息：展示了groupA下当前有2个消费者，以及对应的详细信息，包括：消费者id，消费者ip/port，消费者语言，消费者版本</li><li>消费者组订阅信息：包括订阅的Topic，过滤条件，消费模式，以及从什么位置开始消费等。</li></ol><p>这二者不论哪个信息发生变化，Broker都会主动通知这个消费者组下的所有实例进行Rebalance。在ConsumerManager的registerConsumer方法中，我们可以看到这个通知机制。如以下源码片段第四步中所示： <code>ConsumerManager#registerConsumer</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">registerConsumer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ClientChannelInfo</span> clientChannelInfo<span class="token punctuation">,</span>
    <span class="token class-name">ConsumeType</span> consumeType<span class="token punctuation">,</span> <span class="token class-name">MessageModel</span> messageModel<span class="token punctuation">,</span> <span class="token class-name">ConsumeFromWhere</span> consumeFromWhere<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> subList<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isNotifyConsumerIdsChangedEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    <span class="token comment">//1 查找consumer group信息，如果没有，创建一个新的</span>
    <span class="token class-name">ConsumerGroupInfo</span> consumerGroupInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> consumerGroupInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumerGroupInfo</span> tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerGroupInfo</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> consumeType<span class="token punctuation">,</span> 
                                               messageModel<span class="token punctuation">,</span> consumeFromWhere<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ConsumerGroupInfo</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumerGroupInfo <span class="token operator">=</span> prev <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> prev <span class="token operator">:</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//2 消费者组下实例信息是否发生变化</span>
    <span class="token keyword">boolean</span> r1 <span class="token operator">=</span>
        consumerGroupInfo<span class="token punctuation">.</span><span class="token function">updateChannel</span><span class="token punctuation">(</span>clientChannelInfo<span class="token punctuation">,</span> consumeType<span class="token punctuation">,</span> messageModel<span class="token punctuation">,</span> 
                                        consumeFromWhere<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//3 消费者订阅信息是否发生变化</span>
    <span class="token keyword">boolean</span> r2 <span class="token operator">=</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">updateSubscription</span><span class="token punctuation">(</span>subList<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//4 如果r1或者r2任意一个为true，则通知这个消费者组下的所有实例进行rebalance</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r1 <span class="token operator">||</span> r2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isNotifyConsumerIdsChangedEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumerIdsChangeListener<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ConsumerGroupEvent</span><span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span> 
                                           group<span class="token punctuation">,</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">getAllChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">this</span><span class="token punctuation">.</span>consumerIdsChangeListener<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ConsumerGroupEvent</span><span class="token punctuation">.</span><span class="token constant">REGISTER</span><span class="token punctuation">,</span> group<span class="token punctuation">,</span> subList<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> r1 <span class="token operator">||</span> r2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>consumerIdsChangeListener在处理<code>ConsumerGroupEvent.CHANGE</code>事件时，会给每个Consumer都发送一个<code>NOTIFY_CONSUMER_IDS_CHANGED</code>通知，这个消费者组下的所有实例在收到通知后，各自进行Rebalance，如下图所示：</p><p><img src="/images/RocketMQ/863118-20220212233935653-283344572.png" alt="image"></p><blockquote><p>Broker是通知每个消费者各自Rebalance，即每个消费者自己给自己重新分配队列，而不是Broker将分配好的结果告知Consumer。</p></blockquote><p>从这个角度，RocketMQ与Kafka Rebalance机制类似，二者Rebalance分配都是在客户端进行，不同的是： <code>Kafka</code>：会在消费者组的多个消费者实例中，选出一个作为Group Leader，由这个Group Leader来进行分区分配，分配结果通过Cordinator(特殊角色的broker)同步给其他消费者。相当于Kafka的分区分配只有一个大脑，就是Group Leader。</p><p><code>RocketMQ</code>：每个消费者，自己负责给自己分配队列，相当于每个消费者都是一个大脑。</p><p>此时，我们需要思考2个问题：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>问题1：每个消费者自己给自己分配，如何避免脑裂的问题呢？
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>因为每个消费者都不知道其他消费者分配的结果，会不会出现一个队列分配给了多个消费者，或者有的队列分配给了多个消费者。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>问题2：如果某个消费者没有收到Rebalance通知怎么办？
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><blockquote><p>每个消费者都会定时触发Rebalance，以避免Rebalance通知丢失。</p></blockquote><h4 id="consumeroffsetmanager" tabindex="-1"><a class="header-anchor" href="#consumeroffsetmanager" aria-hidden="true">#</a> ConsumerOffsetManager</h4><p>事实上，通过ConsumerManager已经可以获得Rebalance时需要的消费者所有必要信息。但是还有一点，Rebalance时，如果某个队列重新分配给了某个消费者，那么必须接着从上一个消费者的位置继续开始消费，这就是ConsumerOffsetManager的作用。</p><p>消费者可以给Broker发送<code>UPDATE_CONSUMER_OFFSET</code>请求，来更新消费者组对于某个Topic的消费进度。 发送<code>QUERY_CONSUMER_OFFSET</code>指令，来从ConsumerOffsetManager中查询消费进度。</p><p>通过mqadmin命令行工具的consumerProgress子命令，来可以看到Topic每个队列的消费进度，如：</p><p><img src="/images/RocketMQ/863118-20220212235034744-245488062.png" alt="image"></p><h4 id="subscriptiongroupmanager" tabindex="-1"><a class="header-anchor" href="#subscriptiongroupmanager" aria-hidden="true">#</a> SubscriptionGroupManager</h4><p>订阅组配置管理器，内部针对每个消费者组维护一个SubscriptionGroupConfig。主要是为了针对消费者组进行一些运维操作，这里不做过多介绍，感兴趣的读者自行查阅源码。</p><h2 id="consumer-rebalance机制" tabindex="-1"><a class="header-anchor" href="#consumer-rebalance机制" aria-hidden="true">#</a> Consumer Rebalance机制</h2><p>前面分析Broker在Rebalance过程中起的是协调者的作用，可以帮忙我们从整体对Rebalance有个初步的认知。但是Rebalance的细节，却是在Consumer端完成的。</p><p>在本节中，我们将着重讨论单个consumer的Rebalance流程。</p><p>需要说明的是，RocketMQ的consumer分配pull和push两种模式，二者的工作逻辑并不相同。这里主要以push模式的默认实现类<code>DefaultMQPushConsumer</code>为例进行讲解。</p><h3 id="rebalance触发时机" tabindex="-1"><a class="header-anchor" href="#rebalance触发时机" aria-hidden="true">#</a> Rebalance触发时机</h3><p>在前文，我们提到Broker会主动通知消费者进行Rebalance，但是从消费者的角度来看，整个生命过程的各个阶段，都有可能触发Rebalance，而不仅仅是收到通知后才进行Rebalance。</p><p>具体来说，Consumer在启动/运行时/停止时，都有可能触发Rebalance，如下图所示：</p><p><img src="/images/RocketMQ/863118-20220212235232037-2126774732.png" alt="image"></p><ul><li><code>在启动时</code>，消费者会立即向所有Broker发送一次发送心跳(HEART_BEAT)请求，Broker则会将消费者添加由ConsumerManager维护的某个消费者组中。然后这个Consumer自己会立即触发一次Rebalance。</li><li><code>在运行时</code>，消费者接收到Broker通知会立即触发Rebalance，同时为了避免通知丢失，会周期性触发Rebalance；</li><li><code>当停止时</code>，消费者向所有Broker发送取消注册客户端(UNREGISTER_CLIENT)命令，Broker将消费者从ConsumerManager中移除，并通知其他Consumer进行Rebalance。</li></ul><h4 id="consumer启动" tabindex="-1"><a class="header-anchor" href="#consumer启动" aria-hidden="true">#</a> Consumer启动</h4><p>DefaultMQPushConsumerImpl的start方法显示了一个消费者的启动流程，如下图所示：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
    <span class="token comment">//1 启动准备工作(略)</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
    <span class="token comment">//2 从nameserver更新topic路由信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTopicSubscribeInfoWhenSubscriptionChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3 检查consumer配置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">checkClientInBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4 向每个broker发送心跳信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">sendHeartbeatToAllBrokerWithLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5 立即触发一次rebalance</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">rebalanceImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以看到Consumer启动主要分为5个步骤，其中步骤2、4、5是我们分析的重点。：</p><ul><li>步骤1：启动准备工作，这里使用{...}表示省略，以更清楚看清整个流程</li><li>步骤2：从nameserver更新topic路由信息，收集到了Rebalance所需的队列信息</li><li>步骤3：检查consumer配置(主要是为了功能兼容，例如consumer要使用SQL92过滤，但是broker并没有开启，则broker会返回错误)</li><li>步骤4：向每个broker发送心跳信息，将自己加入消费者组</li><li>步骤5：立即触发一次rebalance，在步骤2和4的基础上立即触发一次Rebalance</li></ul><h5 id="更新订阅的topic路由信息" tabindex="-1"><a class="header-anchor" href="#更新订阅的topic路由信息" aria-hidden="true">#</a> 更新订阅的topic路由信息</h5><p>上述代码步骤2，调用updateTopicSubscribeInfoWhenSubscriptionChanged()方法，从nameserver更新topic路由信息，由于一个消费者可以订阅多个topic，因此这个Topic都需要更新，如下：</p><p><code>MQClientInstance#updateTopicSubscribeInfoWhenSubscriptionChanged</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateTopicSubscribeInfoWhenSubscriptionChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获得的订阅当前Consumer订阅所有Topic信息。key为topic，value为SubscriptionData</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> subTable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subTable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> subTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//从NameServer逐一更新每个topic的路由信息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">updateTopicRouteInfoFromNameServer</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>通过这一步，<strong>当前Consumer就拿到了Topic下所有队列信息</strong>，具备了Rebalance的第一个条件。</p><h5 id="向broker发送心跳信息" tabindex="-1"><a class="header-anchor" href="#向broker发送心跳信息" aria-hidden="true">#</a> 向broker发送心跳信息</h5><p>在上述启动流程中的第4步，调用<code>sendHeartbeatToAllBrokerWithLock</code>方法，给每个Broker都发送一个心跳请求。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">sendHeartbeatToAllBrokerWithLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>当Broker收到心跳请求后，将这个消费者注册到ConsumerManager中，前文提到，当Consumer数量变化时，Broker会主动通知其他消费者进行Rebalance。</p><p>而心跳的数据，这些数据是在MQClientInstance类的prepareHeartbeatData方法来准备的。我们在前文通过mqadmin命令行工具的consumerConnection 自命令查看到的消费者订阅信息，在这里都出现了，如所示：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">HeartbeatData</span> <span class="token function">prepareHeartbeatData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HeartbeatData</span> heartbeatData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeartbeatData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//1 clientID</span>
    heartbeatData<span class="token punctuation">.</span><span class="token function">setClientID</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//2 Consumer心跳信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MQConsumerInner</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MQConsumerInner</span> impl <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConsumerData</span> consumerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            consumerData<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span>impl<span class="token punctuation">.</span><span class="token function">groupName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消费者名称</span>
            consumerData<span class="token punctuation">.</span><span class="token function">setConsumeType</span><span class="token punctuation">(</span>impl<span class="token punctuation">.</span><span class="token function">consumeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消费类型</span>
            consumerData<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span>impl<span class="token punctuation">.</span><span class="token function">messageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消费模式</span>
            consumerData<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span>impl<span class="token punctuation">.</span><span class="token function">consumeFromWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从什么位置开始消费</span>
            consumerData<span class="token punctuation">.</span><span class="token function">getSubscriptionDataSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>impl<span class="token punctuation">.</span><span class="token function">subscriptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//每个topic的订阅信息</span>
            consumerData<span class="token punctuation">.</span><span class="token function">setUnitMode</span><span class="token punctuation">(</span>impl<span class="token punctuation">.</span><span class="token function">isUnitMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            heartbeatData<span class="token punctuation">.</span><span class="token function">getConsumerDataSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>consumerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">//3 Producer心跳信息</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* group */</span><span class="token punctuation">,</span> <span class="token class-name">MQProducerInner</span><span class="token operator">&gt;</span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>producerTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MQProducerInner</span> impl <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ProducerData</span> producerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            producerData<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            heartbeatData<span class="token punctuation">.</span><span class="token function">getProducerDataSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>producerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> heartbeatData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>提示：可以看到心跳数据HeartbeatData中，既包含Consumer信息，也包含Producer信息(这里进行了省略)。</p><h5 id="立即触发一次rebalance" tabindex="-1"><a class="header-anchor" href="#立即触发一次rebalance" aria-hidden="true">#</a> 立即触发一次Rebalance</h5><p>消费者启动流程的最后一步是调用以下方法立即触发一次rebalance：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">rebalanceImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>这个方法内部实际上，是通过唤醒一个RebalanceService，来触发Rebalance：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rebalanceImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里我们并不着急分析RebalanceService的内部具体实现，因为所有的Rebalance触发都是以这个类为入口，我们将在讲解完运行时/停止时的Rebalance触发时机后，统一进行说明。</p><h4 id="consumer运行时" tabindex="-1"><a class="header-anchor" href="#consumer运行时" aria-hidden="true">#</a> Consumer运行时</h4><p>consumer在运行时，通过两种机制来触发Rebalance：</p><ul><li>监听broker 消费者数量变化通知，触发rebalance</li><li>周期性触发rebalance，避免Broker的Rebalance通知丢失。</li></ul><h5 id="监听broker-消费者数量变化通知-触发rebalance" tabindex="-1"><a class="header-anchor" href="#监听broker-消费者数量变化通知-触发rebalance" aria-hidden="true">#</a> 监听broker 消费者数量变化通知，触发rebalance</h5><p>RocketMQ支持双向通信机制，Broker发送给客户端到的通知请求，在客户端通过ClientRemotingProcessor的processRequest方法来处理进行区分处理，如下：</p><p><code>ClientRemotingProcessor#processRequest</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//检查事务消息状态</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">CHECK_TRANSACTION_STATE</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkTransactionState</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通知消费者数量发生变化，内部会触发rebalance</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">NOTIFY_CONSUMER_IDS_CHANGED</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyConsumerIdsChanged</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//重置消费者offset</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">RESET_CONSUMER_CLIENT_OFFSET</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetOffset</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获得消费者状态</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">GET_CONSUMER_STATUS_FROM_CLIENT</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumeStatus</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获得消费者运行时信息</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">GET_CONSUMER_RUNNING_INFO</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerRunningInfo</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//直接消费消息</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">CONSUME_MESSAGE_DIRECTLY</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">consumeMessageDirectly</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>目前，我们关注的是，消费者数量变化时，Broker给客户端的通知，也就是上图中红色框的内容。在收到通知后，其调用<code>notifyConsumerIdsChanged</code>进行处理，这个方法内部会立即触发Rebalance。</p><p><code>ClientRemotingProcessor#notifyConsumerIdsChanged</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">notifyConsumerIdsChanged</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span>
    <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//对Broker的Rebalance通知请求进行解码</span>
        <span class="token keyword">final</span> <span class="token class-name">NotifyConsumerIdsChangedRequestHeader</span> requestHeader <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">NotifyConsumerIdsChangedRequestHeader</span><span class="token punctuation">)</span> 
            request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">NotifyConsumerIdsChangedRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//打印Rebalance通知信息</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>&quot;receive broker&#39;s notification<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> the consumer group<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> 
            changed<span class="token punctuation">,</span> rebalance immediately&quot;<span class="token punctuation">,</span>
            <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//立即触发Rebalance</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">rebalanceImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;notifyConsumerIdsChanged exception&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">exceptionSimpleDesc</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到这里是调用mqClientFactory的rebalanceImmediately方法触发Rebalance，而前面讲解消费者启动时是通过RebalanceService触发，事实上，后者RebalanceService内部也是通过mqClientFactory进行触发Rebalance。</p><h5 id="周期性触发rebalance-避免broker的rebalance通知丢失" tabindex="-1"><a class="header-anchor" href="#周期性触发rebalance-避免broker的rebalance通知丢失" aria-hidden="true">#</a> 周期性触发rebalance，避免Broker的Rebalance通知丢失</h5><p>为了避免Broker的Rebalance通知丢失问题，客户端还会通过RebalanceService定时的触发Rebalance，默认间隔是20秒，如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RebalanceService</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceThread</span> <span class="token punctuation">{</span>
    <span class="token comment">//1 周期性触发Rebalance时间间隔，默认20秒</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">long</span> waitInterval <span class="token operator">=</span>
        <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmq.client.rebalance.waitInterval&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;20000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">InternalLogger</span> log <span class="token operator">=</span> <span class="token class-name">ClientLogger</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MQClientInstance</span> mqClientFactory<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">RebalanceService</span><span class="token punctuation">(</span><span class="token class-name">MQClientInstance</span> mqClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory <span class="token operator">=</span> mqClientFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2 在消费者没有停止的情况下，通过死循环定时触发Rebalance</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3 等待20秒，如果被唤醒，则无需等待</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>waitInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4 触发Rebalance</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">RebalanceService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="consumer停止" tabindex="-1"><a class="header-anchor" href="#consumer停止" aria-hidden="true">#</a> consumer停止</h4><p>最后，消费者在正常停止时，需要调用shutdown方法，这个方法的工作逻辑如下所示：</p><p><code>DefaultMQPushConsumerImpl#shutdown</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">CREATE_JUST</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">RUNNING</span><span class="token operator">:</span>
            <span class="token comment">//1 停止正在消费中的消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2 持久化offset</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persistConsumerOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3 取消注册consumer</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">unregisterConsumer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4 关闭与name server和broker的连接</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the consumer [{}] shutdown OK&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5 丢弃尚未处理的消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">SHUTDOWN_ALREADY</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">SHUTDOWN_ALREADY</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>可以看到停止也分为5步，我们重点关注第2、3步：</p><ul><li>在停止时，会首先通过第2步<code>持久化offset</code>，前文提到过默认情况下，offset是异步提交的，为了避免重复消费，因此在关闭时，必须要对尚未提交的offset进行持久化，其实就是发送UPDATE_CONSUMER_OFFSET请求给Broker，Broker对应更新ConsumerOffsetManager中的记录。这样当队列分配给其他消费者时，就可以从这个位置继续开始消费。</li><li>接着第3步调用<code>unregisterConsumer</code>方法，向所有broker发送UNREGISTER_CLIENT命令，取消注册Consumer。broker接收到这个命令后，将consumer从ConsumerManager中移除，然后通知这个消费者下的其他Consumer进行Rebalance。</li></ul><p>至此，我们已经讲解完了Consumer启动时/运行时/停止时，所有可能的Rebalance触发时机</p><h2 id="单个消费者rebalance流程" tabindex="-1"><a class="header-anchor" href="#单个消费者rebalance流程" aria-hidden="true">#</a> 单个消费者Rebalance流程</h2><h3 id="整体介绍" tabindex="-1"><a class="header-anchor" href="#整体介绍" aria-hidden="true">#</a> 整体介绍</h3><p>前面提到Consumer的Rebalance触发时机有很多，Broker主动通知某个消费者组需要进行Rebalance；RebalanceService也会定时20秒触发Rebalance。然而需要注意的是，<code>只要任意一个消费者组需要Rebalance，这台机器上启动的所有其他消费者，也都要进行Rebalance</code>。 不同的触发机制最终底层都调用了MQClientInstance的doRebalance方法，而在这个方法的源码中，并没有区分哪个消费者组需要进行Rebalance，而是逐一进行触发，如下：</p><p><code>MQClientInstance#doRebalance</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//迭代每个consumer，进行rebalance</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">MQConsumerInner</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MQConsumerInner</span> impl <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//逐一触发Rebalance</span>
                impl<span class="token punctuation">.</span><span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上述代码逐一迭代当前机器启动的所有消费者(MQConsumerInner)，并调用其doRebalance方法进行触发Rebalance。</p><p>MQConsumerInner有push模式和pull模式两种实现，分别是：<code>DefaultMQPushConsumerImpl</code>和<code>DefaultMQPullConsumerImpl</code>，二者的Rebalance逻辑并不相同。 对于push模式，其会根据消费者指定的消息监听器是有序还是无序进行判定Rebalance过程中是否需要对有序消费进行特殊处理。</p><p>参见：<code>DefaultMQPushConsumerImpl#doRebalance</code>。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果MessageListenerOrderly，则为true；否则为false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isConsumeOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>而pull模式，总是认为是无序的，因为写死了为false。参见：DefaultMQPullConsumerImpl#doRebalance</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们看到，不管是push还是pull模式的Consumer实现，内部都是调用RebalanceImpl的doRebalance方法进行触发，将是否有序作为一个参数传入。</p><p>在这个方法内部，如果一个消费者订阅了多个Topic，会迭代每个Topic维度逐一触发Rebalance。相关源码如下所示：</p><p><code>RebalanceImpl#doRebalance</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//1 迭代当前consumer订阅的每一个topic，逐一进行rebalance</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> subTable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subTable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> subTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//2 按照topic维度进行rebalance</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;rebalanceByTopic Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">truncateMessageQueueNotMyTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>在这一点上，Kafka与不RocketMQ同，其是将所有Topic下的所有队列合并在一起，进行Rebalance。 RocketMQ按照Topic维度进行Rebalance，会导致一个很严重的结果：如果一个消费者组订阅多个Topic，可能会出现分配不均。 举例来说：某个消费者组group_X下有4个消费者实例，分别部署在192.168.0.[1-4] 4台机器上；订阅了两个主题：TopicX和TopicY。如下图：</p><p><img src="/images/RocketMQ/863118-20220213000344825-805438762.png" alt="image"></p><p>其中：001~004表示的就是这4个消费者的信息，而订阅信息显示了订阅TopicX和TopicY。</p><p>TopicX、TopicY各有2个队列，因此总共有4个队列；而刚好又有4个消费者，我们的期望是每个消费者分配一个队列。然后实际分配情况如下图所示：</p><p><img src="/images/RocketMQ/863118-20220213000937054-315720411.png" alt="image"></p><p>通过观察Client IP列，我们看到192.168.0.1、192.168.0.2各出现2两次，也就是分配到了两个队列，另外2个IP(192.168.0.3、192.168.0.4)并没有出现，表示没有分配到任何队列。</p><p>之所以出现分配不均，就是因为按照Topic维度进行Rebalance，因此这里TopicX和TopicY会各Rebalance一次。且每次Rebalance时都对消费者组下的实例进行排序，所以TopicX和TopicY各自的两个队列，都分配给消费者组中的前两个消费者了。</p><p><code>由于订阅多个Topic时可能会出现分配不均，这是在RocketMQ中我们为什么不建议同一个消费者组订阅多个Topic的重要原因</code>。另一款消息中间件Kafka会将所有Topic队列合并在一起，然后在消费者中进行分配，因此相对会更加平均。</p><h3 id="单个topic的rebalance流程" tabindex="-1"><a class="header-anchor" href="#单个topic的rebalance流程" aria-hidden="true">#</a> 单个Topic的Rebalance流程</h3><p>对于每个Topic的Rebalance的触发，都是通过RebalanceImpl#rebalanceByTopic方法。这个方法从整体上可以分为3大步骤：</p><ol><li>获得Rebalance元数据信息</li><li>进行队列分配</li><li>分配结果处理</li></ol><p><code>RebalanceImpl#rebalanceByTopic</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>rivate <span class="token keyword">void</span> <span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 广播模式，略</span>
        <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
        <span class="token comment">//集群模式</span>
        <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">//1. 获得要Rebalance的元数据</span>
            <span class="token comment">//mqSet：Topic下的队列信息集合</span>
            <span class="token comment">//cidAll: 消费者组下的消费者实例id信息集合</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqSet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicSubscribeInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findConsumerIdList</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> mqSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance, {}, but the topic[{}] not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> cidAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance, {} {}, get consumer id list failed&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mqSet <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cidAll <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mqAll<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                <span class="token comment">//2. 进行分配</span>
                <span class="token comment">//2.1 首先对Topic下的所有队列，和所有消费者实例id分别进行排序</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                <span class="token comment">//2.2 通过AllocateMessageQueueStrategy，进行预分配</span>
                <span class="token class-name">AllocateMessageQueueStrategy</span> strategy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMessageQueueStrategy<span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    allocateResult <span class="token operator">=</span> strategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mqAll<span class="token punctuation">,</span>
                        cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;AllocateMessageQueueStrategy.allocate Exception...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
 
                <span class="token comment">//3 分配结果处理</span>
                <span class="token comment">//3.1 分配结果去重</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResultSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allocateResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    allocateResultSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allocateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
 
                <span class="token comment">//3.2 根据预分配到的结果尝试更新ProcessQueue Table，并返回true or false表示是否发生变更</span>
                <span class="token keyword">boolean</span> changed <span class="token operator">=</span> 
                      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateProcessQueueTableInRebalance</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
                <span class="token comment">//3.3 如果分配结果发生变更，进行后续处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;rebalanced result changed. allocateMessageQueueStrategyName={}...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">messageQueueChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> mqSet<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h4 id="获得rebalance元数据" tabindex="-1"><a class="header-anchor" href="#获得rebalance元数据" aria-hidden="true">#</a> 获得Rebalance元数据</h4><p>消费者在Rebalance时需要获得：Topic下的队列信息，和消费者组下实例id信息。</p><ul><li>对于队列信息：会从之前的缓存的Topic路由信息中获取；</li><li>对于消费者组实例id信息：前面我们提到过Broker通过<code>ConsumerManager</code>维护了所有的消费者信息，findConsumerIdList方法内部会会发送<code>GET_CONSUMER_LIST_BY_GROUP</code>给请求给任意一个Broker进行获取。</li></ul><h4 id="进行队列分配" tabindex="-1"><a class="header-anchor" href="#进行队列分配" aria-hidden="true">#</a> 进行队列分配</h4><p>RocketMQ的分配策略使用AllocateMessageQueueStrategy接口表示，并提供了多种实现：</p><table><thead><tr><th style="text-align:left;">AllocateMessageQueueAveragely</th><th style="text-align:left;">平均分配 默认</th></tr></thead><tbody><tr><td style="text-align:left;">AllocateMessageQueueAveragelyByCircle</td><td style="text-align:left;">循环分配</td></tr><tr><td style="text-align:left;">AllocateMessageQueueConsistentHash</td><td style="text-align:left;">一致性哈希</td></tr><tr><td style="text-align:left;">AllocateMessageQueueByConfig</td><td style="text-align:left;">根据配置进行分配</td></tr><tr><td style="text-align:left;">AllocateMessageQueueByMachineRoom</td><td style="text-align:left;">根据机房</td></tr><tr><td style="text-align:left;">AllocateMachineRoomNearby</td><td style="text-align:left;">就近分配</td></tr></tbody></table><p>在前面，我们提到过RocketMQ的Rebalance流程中，消费者组下的多个实例，自己给自己分配队列，相当于存在多个大脑。那么<code>如何保证分配结果的一致呢</code>？</p><p>通过以下两个手段来保证：</p><ul><li>首先，<strong>在分配之前，需要对Topic下的多个队列进行排序，对多个消费者实例按照id进行排序</strong></li><li>其次，<strong>每个消费者需要使用相同的分配策略</strong>。</li></ul><p>这里以AllocateMessageQueueAveragely分配为例来进行说明。假设某个Topic有10个队列，消费者组有3个实例c1、c2、c3，使用AllocateMessageQueueAveragely分配结果如下图所示：</p><p><img src="/images/RocketMQ/863118-20220213001331286-1776201859.png" alt="image"></p><p>在分配时，每个消费者(c1、c2、c3)平均分配3个，此时还多出1个，多出来的队列按顺序分配给消费者队列的头部元素，因此c1多分配1个，最终c1分配了4个队列。</p><p>尽管每个消费者是各自给自己分配，但是因为使用的相同的分配策略，定位从队列列表中哪个位置开始给自己分配，给自己分配多少个队列，从而保证最终分配结果的一致。</p><p><code>AllocateMessageQueueAveragely</code>源码如下所示：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllocateMessageQueueAveragely</span> <span class="token keyword">implements</span> <span class="token class-name">AllocateMessageQueueStrategy</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">InternalLogger</span> log <span class="token operator">=</span> <span class="token class-name">ClientLogger</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerGroup<span class="token punctuation">,</span> <span class="token class-name">String</span> currentCID<span class="token punctuation">,</span> 
                         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//...检查工作，略</span>
 
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cidAll<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>currentCID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[BUG] ConsumerGroup: {} The consumerId: {} not in cidAll: {}&quot;</span><span class="token punctuation">,</span>
                consumerGroup<span class="token punctuation">,</span>
                currentCID<span class="token punctuation">,</span>
                cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//计算自己再消费者列表中的位置</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> cidAll<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>currentCID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//计算平均分配后，多出来的数量</span>
        <span class="token keyword">int</span> mod <span class="token operator">=</span> mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//计算每个消费者平均分配的数量，</span>
        <span class="token comment">//如果不能平均分配(mod&gt;0)，取模多出来的队列，将分配消费者列表中的前几个消费者</span>
        <span class="token keyword">int</span> averageSize <span class="token operator">=</span>
            <span class="token comment">//1 如果队列数量&lt;=消费者数量，将averageSize设置为1，即每个队列分配1个</span>
            mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> 
                    <span class="token comment">//2 如果队列数量多于消费者数量</span>
                    <span class="token comment">//如果不能平均分配(mod &gt; 0)，并且自己的位置小于取模的位置(index &lt; mod)</span>
                    <span class="token punctuation">(</span>mod <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> mod <span class="token operator">?</span> 
                            mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">//在平均分配的基础上多分配一个</span>
                            <span class="token operator">:</span> mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进行平均分配</span>
 
        <span class="token comment">//计算分配给自己的队列列表中的起始位置</span>
        <span class="token keyword">int</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>mod <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> mod<span class="token punctuation">)</span> <span class="token operator">?</span> 
                      index <span class="token operator">*</span> averageSize <span class="token operator">:</span> index <span class="token operator">*</span> averageSize <span class="token operator">+</span> mod<span class="token punctuation">;</span>
        <span class="token comment">//计算range，即分配给自己几个队列。</span>
        <span class="token comment">// 由于计算出的averageSize最小为1，当队列数量是小于消费者数量，多出来的消费者应该分配为0，所</span>
        <span class="token comment">//以取(mqAll.size() - startIndex)</span>
        <span class="token keyword">int</span> range <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>averageSize<span class="token punctuation">,</span> mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从起始位置开始，循环range次，把对应的队列分配给自己</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> range<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span>startIndex <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> mqAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//返回</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;AVG&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>对于其他分配策略，感兴趣的读者可以自行阅读源码，在实际开发中使用的很少。</p><p>特别的，mqadmin工具提供了一个allocateMQ子命令，通过其我们可以预览某个Topic在多个消费者分区是如何分配的，使用方式如下：</p><blockquote><p>sh bin/mqadmin allocateMQ -i ip1,ip2,ip3 -t TopicA -n localhost:9876</p></blockquote><p>这个工具是按照AllocateMessageQueueAveragely策略，将模拟分配的结果进行json格式展示。</p><h4 id="分配结果处理" tabindex="-1"><a class="header-anchor" href="#分配结果处理" aria-hidden="true">#</a> 分配结果处理</h4><p>消费者计算出分配给自己的队列结果后，需要与之前进行比较，判断添加了新的队列，或者移除了之前分配的队列，也可能没有变化。</p><ul><li>对于新增的队列，需要先计算从哪个位置开始消费，接着从这个位置开始拉取消息进行消费；</li><li>对于移除的队列，要移除缓存的消息，并停止拉取消息，并持久化offset。</li></ul><p>这些操作都是在<code>RebalanceImpl#updateProcessQueueTableInRebalance</code>中进行。</p><h4 id="其他操作" tabindex="-1"><a class="header-anchor" href="#其他操作" aria-hidden="true">#</a> 其他操作</h4><p>处理完队列变更后，会调用messageQueueChanged方法进行最后一步处理。 对于push和pull的处理逻辑不同。</p><ul><li>对于push模式主要是进行一些流控参数的更新。</li><li>对于pull模式是回调用户自定义的MessageQueueListener。 参考：RebalancePullImpl#messageQueueChanged</li></ul><p><code>RebalancePullImpl#messageQueueChanged</code></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">messageQueueChanged</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqDivided<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MessageQueueListener</span> messageQueueListener <span class="token operator">=</span> 
             <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPullConsumerImpl<span class="token punctuation">.</span><span class="token function">getDefaultMQPullConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageQueueListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageQueueListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//回调用户注册的队列变更监听器</span>
            messageQueueListener<span class="token punctuation">.</span><span class="token function">messageQueueChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> mqAll<span class="token punctuation">,</span> mqDivided<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;messageQueueChanged exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2><p><a href="https://www.cnblogs.com/mpyidudu/p/15887951.html" target="_blank" rel="noopener noreferrer">深入理解RocketMQ消费者Rebalance机制<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/RocketMQ/" class="nav-link router-link-active" aria-label="Back To 目录"><!--[--><!--]--> Back To 目录 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.2c87fbe0.js" defer></script><script src="/assets/js/95615.aba5921d.js" defer></script><script src="/assets/js/app.4aafd1f6.js" defer></script>
  </body>
</html>
