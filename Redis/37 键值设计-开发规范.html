<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/images/favicon-32x32.png"><title>静默のBlog</title><meta name="description" content="静默的Vuepress Blog">
    <link rel="preload" href="/assets/js/runtime~app.2c87fbe0.js" as="script"><link rel="preload" href="/assets/css/styles.b779b927.css" as="style"><link rel="preload" href="/assets/js/95615.aba5921d.js" as="script"><link rel="preload" href="/assets/js/app.4aafd1f6.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b779b927.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">静默のBlog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="📗Menu"><!--[--><!--]--> 📗Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item"></p><ul class=""><li><!--[--><a aria-current="page" href="/Redis/37%20%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html#key名设计" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="key名设计"><!--[--><!--]--> key名设计 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/Redis/37%20%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html#value设计" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="value设计"><!--[--><!--]--> value设计 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/Redis/37%20%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html#bigkey的危害" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="bigkey的危害"><!--[--><!--]--> bigkey的危害 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/Redis/37%20%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html#bigkey的产生" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="bigkey的产生"><!--[--><!--]--> bigkey的产生 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/Redis/37%20%E9%94%AE%E5%80%BC%E8%AE%BE%E8%AE%A1-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83.html#如何优化bigkey" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="如何优化bigkey"><!--[--><!--]--> 如何优化bigkey <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="key名设计" tabindex="-1"><a class="header-anchor" href="#key名设计" aria-hidden="true">#</a> <strong>key名设计</strong></h2><ol><li><p>【建议】: 可读性和可管理性</p><p>以业务名(或数据库名)为前缀(防止key冲突)，用冒号分隔，比如业务名:表名:id</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>trade:order:1
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>【建议】：简洁性</p><p>保证语义的前提下，控制key的长度，当key较多时，内存占用也不容忽视，例如：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>user<span class="token operator">:</span><span class="token punctuation">{</span>uid<span class="token punctuation">}</span><span class="token operator">:</span>friends<span class="token operator">:</span>messages<span class="token operator">:</span><span class="token punctuation">{</span>mid<span class="token punctuation">}</span> 简化为 u<span class="token operator">:</span><span class="token punctuation">{</span>uid<span class="token punctuation">}</span><span class="token operator">:</span>fr<span class="token operator">:</span>m<span class="token operator">:</span><span class="token punctuation">{</span>mid<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>【强制】：不要包含特殊字符</p><p>反例：包含空格、换行、单双引号以及其他转义字符</p></li></ol><h2 id="value设计" tabindex="-1"><a class="header-anchor" href="#value设计" aria-hidden="true">#</a> <strong>value设计</strong></h2><ul><li>【强制】：拒绝bigkey(防止网卡流量、慢查询)</li></ul><p>在Redis中，一个字符串最大512MB，一个二级数据结构（例如hash、list、set、zset）可以存储大约40亿个(2^32-1)个元素，但实际中如果下面两种情况，我就会认为它是bigkey。</p><ol><li>字符串类型：它的big体现在单个value值很大，一般认为超过10KB就是bigkey。</li><li>非字符串类型：哈希、列表、集合、有序集合，它们的big体现在元素个数太多。</li></ol><blockquote><p><strong>一般来说，string类型控制在10KB以内，hash、list、set、zset元素个数不要超过5000。</strong></p></blockquote><p>反例：一个包含200万个元素的list。</p><p>非字符串的bigkey，不要使用del删除，使用hscan、sscan、zscan方式渐进式删除，同时要注意防止bigkey过期时间自动删除问题(例如一个200万的zset设置1小时过期，会触发del操作，造成阻塞）</p><h2 id="bigkey的危害" tabindex="-1"><a class="header-anchor" href="#bigkey的危害" aria-hidden="true">#</a> <strong>bigkey的危害</strong></h2><ol><li><p>导致redis阻塞</p></li><li><p>网络拥塞</p><blockquote><p>bigkey也就意味着每次获取要产生的网络流量较大，假设一个bigkey为1MB，客户端每秒访问量为1000，那么每秒产生1000MB的流量，对于普通的千兆网卡(按照字节算是128MB/s)的服务器来说简直是灭顶之灾，而且一般服务器会采用单机多实例的方式来部署，也就是说一个bigkey可能会对其他实例也造成影响，其后果不堪设想。</p></blockquote></li><li><p>过期删除</p><blockquote><p>有个bigkey，它安分守己（只执行简单的命令，例如hget、lpop、zscore等），但它设置了过期时间，当它过期后，会被删除，如果没有使用Redis 4.0的过期异步删除(<strong>lazyfree-lazy-expire yes</strong>)，就会存在阻塞Redis的可能性。</p></blockquote></li></ol><h2 id="bigkey的产生" tabindex="-1"><a class="header-anchor" href="#bigkey的产生" aria-hidden="true">#</a> <strong>bigkey的产生</strong></h2><p>一般来说，bigkey的产生都是由于程序设计不当，或者对于数据规模预料不清楚造成的，来看几个例子：</p><ol><li>社交类：粉丝列表，如果某些明星或者大v不精心设计下，必是bigkey。</li><li>统计类：例如按天存储某项功能或者网站的用户集合，除非没几个人用，否则必是bigkey。</li><li>缓存类：将数据从数据库load出来序列化放到Redis里，这个方式非常常用，但有两个地方需要注意，第一，是不是有必要把所有字段都缓存；第二，有没有相关关联的数据，有的同学为了图方便把相关数据都存一个key下，产生bigkey。</li></ol><h2 id="如何优化bigkey" tabindex="-1"><a class="header-anchor" href="#如何优化bigkey" aria-hidden="true">#</a> <strong>如何优化bigkey</strong></h2><ol><li><p>拆</p><p>big hash：可以讲数据分段存储，比如一个大的key，假设存了1百万的用户数据，可以拆分成200个key，每个key下面存放5000个用户数据</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>big list： list1、list2、<span class="token punctuation">..</span>.listN
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>如果bigkey不可避免，也要思考一下要不要每次把所有元素都取出来(例如有时候仅仅需要hmget，而不是hgetall)，删除也是一样，尽量使用优雅的方式来处理。</p></li><li><p>【推荐】：选择适合的数据类型。</p><p>例如：实体类型(要合理控制和使用数据结构，但也要注意节省内存和性能之间的平衡)</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 反例</span>
<span class="token builtin class-name">set</span> user:1:name tom
<span class="token builtin class-name">set</span> user:1:age <span class="token number">19</span>
<span class="token builtin class-name">set</span> user:1:favor football
<span class="token comment"># 正例</span>
hmset user:1 name tom age <span class="token number">19</span> favor football
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>【推荐】：<strong>控制key的生命周期，redis不是垃圾桶</strong>。</p><p>建议使用expire设置过期时间(条件允许可以打散过期时间，防止集中过期)。</p></li></ol><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/Redis/" class="nav-link router-link-active" aria-label="Back To 目录"><!--[--><!--]--> Back To 目录 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.2c87fbe0.js" defer></script><script src="/assets/js/95615.aba5921d.js" defer></script><script src="/assets/js/app.4aafd1f6.js" defer></script>
  </body>
</html>
